<!doctype html>
<html>
  <head>
<style>

/* PrismJS 1.22.0
https://prismjs.com/download.html#themes=prism&languages=markup+css+clike+javascript+solidity&plugins=line-numbers+autolinker+match-braces */
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
  color: black;
  background: none;
  text-shadow: 0 1px white;
  font-family: Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace;
  font-size: 1em;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

pre[class*="language-"]::-moz-selection,
pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection,
code[class*="language-"] ::-moz-selection {
  text-shadow: none;
  background: #b3d4fc;
}

pre[class*="language-"]::selection,
pre[class*="language-"] ::selection,
code[class*="language-"]::selection,
code[class*="language-"] ::selection {
  text-shadow: none;
  background: #b3d4fc;
}

@media print {
  code[class*="language-"],
  pre[class*="language-"] {
    text-shadow: none;
  }
}

/* Code blocks */
pre[class*="language-"] {
  padding: 1em;
  margin: 0.5em 0;
  overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
  background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: 0.1em;
  border-radius: 0.3em;
  white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
  color: slategray;
}

.token.punctuation {
  color: #999;
}

.token.namespace {
  opacity: 0.7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
  color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
  color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
  color: #9a6e3a;
  /* This background color was intended by the author of this theme. */
  background: hsla(0, 0%, 100%, 0.5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
  color: #07a;
}

.token.function,
.token.class-name {
  color: #dd4a68;
}

.token.regex,
.token.important,
.token.variable {
  color: #e90;
}

.token.important,
.token.bold {
  font-weight: bold;
}
.token.italic {
  font-style: italic;
}

.token.entity {
  cursor: help;
}

pre[class*="language-"].line-numbers {
  position: relative;
  padding-left: 3.8em;
  counter-reset: linenumber;
}

pre[class*="language-"].line-numbers > code {
  position: relative;
  white-space: inherit;
}

.line-numbers .line-numbers-rows {
  position: absolute;
  pointer-events: none;
  top: 0;
  font-size: 100%;
  left: -3.8em;
  width: 3em; /* works for line-numbers below 1000 lines */
  letter-spacing: -1px;
  border-right: 1px solid #999;

  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.line-numbers-rows > span {
  display: block;
  counter-increment: linenumber;
}

.line-numbers-rows > span:before {
  content: counter(linenumber);
  color: #999;
  display: block;
  padding-right: 0.8em;
  text-align: right;
}

.token a {
  color: inherit;
}
.token.punctuation.brace-hover,
.token.punctuation.brace-selected {
  outline: solid 1px;
}

.rainbow-braces .token.punctuation.brace-level-1,
.rainbow-braces .token.punctuation.brace-level-5,
.rainbow-braces .token.punctuation.brace-level-9 {
  color: #e50;
  opacity: 1;
}
.rainbow-braces .token.punctuation.brace-level-2,
.rainbow-braces .token.punctuation.brace-level-6,
.rainbow-braces .token.punctuation.brace-level-10 {
  color: #0b3;
  opacity: 1;
}
.rainbow-braces .token.punctuation.brace-level-3,
.rainbow-braces .token.punctuation.brace-level-7,
.rainbow-braces .token.punctuation.brace-level-11 {
  color: #26f;
  opacity: 1;
}
.rainbow-braces .token.punctuation.brace-level-4,
.rainbow-braces .token.punctuation.brace-level-8,
.rainbow-braces .token.punctuation.brace-level-12 {
  color: #e0e;
  opacity: 1;
}
</style>
<link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">

<style>

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
h1 {
  font-size: 1.5em;
}

h2 {
  font-size: 1.32em;
}

h3 {
  font-size: 1.17em;
}

.level {
  display: flex;
  flex-direction: row;
  line-height: 1.4;
  align-items: baseline;
  position: relative;
}

.level:first-child {
  padding-top: 3rem;
}

.level.scrollHighlighted {
  background: rgb(150 159 228 / 48%);
  border-right: 10px solid #515ba27a;
}

.titleLevel .left-background  {
  padding-top: 2em;
  //border-bottom: 4px solid #e5e5ee;
}

.left, .right {
  //border: 1px solid red;
}
.left-background {
  background: #f5f5ff;
  border-right: 1px solid #e5e5ee;
  width: 34rem;
  position: absolute;
  top: 0px;
  bottom: 0px;
  left: -1px;
  z-index: -1;
  padding-left: 4em;
}

.hover-background {
  border-top: 1px solid rgb(229 229 238 / 0.8);
  border-bottom: 1px solid rgb(229 229 238 / 0.3);
  right: 0px;
  width: auto;
  background: rgb(254 255 227 / 0.1);
  position: absolute;
  top: 0px;
  bottom: 0px;
  left: -1px;
  z-index: -1;
  padding-left: 4em;
  visibility: hidden;
}

body:not(.bodyFocusing) .level:hover .hover-background {
  visibility: visible;
}

.left {
  padding-left: 4rem;
  width: 34rem;
  align-items: stretch;
  font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
  text-align:right;
  flex-shrink: 0;
  flex-grow: 0;
}

.level .left {
  font-size: 1.1em;
  line-height: 1.44;
}


.lineComment {
  max-width: 80%;
  font-size:0.9em;
  text-align: right;
  background: white;
  display: inline-flex;
  flex-direction: column;
  //margin-right: calc(-1px);
  padding-top: 0.2rem;
  padding-bottom: 0.2rem;
  border: 1px solid #e5e5ee;
  border-right: none;
  padding-right: 1rem;
  padding-left: 1rem;
  margin-bottom: 2px;
  margin-left: 1rem;
  border-radius: 5px 0px 0px 5px;
}

.lineComment p {
  margin: 0
}

.blockComment {
  margin-right: 3rem;
  text-align: justify;
}

.blockComment *:not(li,code,.katex *) {
  margin-top: 0px;
  margin-bottom: 1.44em;
}

.blockComment *:last-child:not(li,code,.katex *) {
  margin-bottom: 0.72em;
}

.blockComment *:first-child:not(li,code,.katex *) {
  margin-top: 0.72em;
}

.blockComment p + ul,
.blockComment p + ol
{
  margin-top: -0.72em;
}

.blockComment ul, .blockComment ol {
  margin-bottom: 0.72em;
}

// fixme not working like I want
.blockCommont:not(:first-child) {
  margin-top: 1em;
}
.blockComment pre {
  white-space: pre-wrap;
  font-size: 0.84em;
  line-height: 1.44;
  margin-top: -1.055em;
  margin-bottom: 1.055em;
  background: hsl(240 21% 102% / 1);
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  padding-left: 0.5em;
  padding-right: 2em;
}

p code, ul code, ol code {
  background: hsl(240 21% 102% / 1);
  padding: 0.2em;
}



.right {
  position: relative;
  top: 0px;
  width: 50%;
  //padding-left: 0.5rem;
  display: flex;
} 

.right, .lines {
  line-height: 1.95;
}

.focusing {
  background: rgb(254 255 227);
}

.right:hover {
  //border: 1px solid blue;
}
.right code {
}

.codewrap {
  display: flex;
  flex-direction: row;
  transition: transform 300ms ease-in-out;
}

.focuser {
  align-self: stretch;
  flex-shrink: 0;
  font-size: 1.3rem;
  text-align: center;
  display: flex;
  flex-direction: row;
  justify-content: flex-start;
  color: white;
  z-index: 1000;
  position: absolute;
  left: 0;
  top: 0;
  width: 3.2rem;
  height: 100%;
}

.focus-icon {
  //line-height: 0.85;
  font-size: 1.5rem;
  width: 1em;
  flex-grow: 0;
  flex-shrink: 0;
}

.focus-icon:before, .focus-icon:after {
  position: absolute;
  text-align: center;
  display: block;
  left: 0;
  width: 1em;
  visibility: hidden;
  color: #797979;
}

.focus-icon:before {
  content:"↡";
  top: -1.55em;
  pointer-events: none;
}


.focus-icon:after {
  content:"↟";
  bottom: -1.45em;
  pointer-events: none;
}

body:not(.bodyFocusing) .focuser:hover,
body:not(.bodyFocusing) .focusing .focuser {
  border-top: 1px dashed #797979;
  border-bottom: 1px dashed #797979;
  cursor: pointer;
}

body:not(.bodyFocusing) .focuser:hover .focus-icon:before, 
body:not(.bodyFocusing) .focuser:hover .focus-icon:after,
body:not(.bodyFocusing) .focusing .focus-icon:before, 
body:not(.bodyFocusing) .focusing .focus-icon:after {
  visibility: visible;
}

pre {
  margin: 0;
}

.right {
  position: relative;
}
.lines {
  width: content;
  flex-shrink: 0;
  margin-right: 0;
  color: #797979;
  text-align: right;
  display: flex;
  justify-content: flex-end;
  margin-right: 1em;
}
.lines pre {
  width: 3.5em;
  pointer-events: none;
}

body {
  display: flex;
  flex-direction: row;
}

nav {
  width: 22em;
  flex-shrink: 0;
  background: hsl(240 47% 17% / 1);
  position: sticky;
  top: 0px;
  font-size: 0.9em;
  padding-top: 3rem;
  padding-bottom: 3rem;
  height: calc(100vh - 6rem);
  font-family: 'Lato', sans-serif;
  background: #f5f5ff;
  overflow-y: auto;
}

nav a {
  color: hsl(240 82% 98% / 1);
  color: black;
  display: block;
  text-decoration: none;
  line-height: 1;
  padding-left: 3rem;
}

nav a:hover {
  background: white;
}

nav a.highlight {
  background: white;
}

nav a.toc-file:hover {
  background: black;
}

.toc-file {
  font-family: monospace;
  font-size: 1.3em;
  padding-top: 0.7em;
  padding-bottom: 0.6em;
  border-top: 1px solid #e5e5ee;
  border-bottom: 1px solid #e5e5ee;
  background: #37718E;
  color: white;
}

* + .toc-file {
  margin-top: 2em;
}

.toc-h1 {
  font-size: 1.2em;
  font-weight: 600;
  padding-top: 0.6em;
  padding-bottom: 0.55em;
}

.toc-h2 {
  font-size: 1em;
  padding-left: 3.5rem;
  padding-top: 0.4em;
  padding-bottom: 0.4em;
}

.toc-h3 + .toc-h2 {
  margin-top: .4em;
}

.toc-h3 + .toc-h1,
.toc-h2 + .toc-h1 {
  margin-top: .4em;
}

.toc-h3 {
  font-size: 0.8em;
  padding-left: 6.5rem;
  padding-top: 0.4em;
  padding-botom: 0.6em;
}

a {
  color: black;
}

.filebreak {
  width: calc(100% - 4em - 2px);
  font-family: monospace;
  /*background: #e5e5ee;*/
  background: #37718E;
  color: white;
  text-align: left;
  font-size: 1.18em !important;
  padding-top: 0.7em;
  padding-bottom: 0.6em;
  line-height: 1 !important;
  border-top: 1px solid #e5e5ee;
  border-bottom: 1px solid #e5e5ee;
}

.katex { 
  font-size: 1em;
}
</style>
<script>

/* Bounds of DOM element, including margin */
let bounds = (el,wsy) => {
  const rect = el.getBoundingClientRect();
  const style = getComputedStyle(el);
  return {
    top: wsy + rect.top - parseInt(style.marginTop),
    bottom: wsy + rect.bottom + parseInt(style.marginBottom)
  };
};

window.addEventListener('DOMContentLoaded', () => {

  /* For future reference. The current TOC highlight fails when you scroll up into a no-headings zone. Then the highlighted heading is the one below the bottom of the viewport; it should be the one above the top of the viewport. A more complete decision tree for future implementation:
  * have an array of all heading elements, and they know their position in the array
  * have a pointer to "lowest heading above viewport lower edge ("the fold").
  * keep set of visible elements
  * when an element comes in or out of the set, run:
  lowestAboveFold = i
  point = lower above fold
  for entry in entries
    if entry.out
      if entry.too_low
        if point below or is entry
          point = entry.prev
        else ()
      else (entry.too_high)
        if nobody_visible () [???]
        else () [???]
    else (entry.in)
      if point above or is entry
        point = entry
  */

  /* Keep roughly track of currently viewed section, highlight corresponding toc in nav */
  const visibleHeadings = new Set();
  const observer = new IntersectionObserver(entries => {
    for (const entry of entries)
      visibleHeadings[entry.isIntersecting ? 'add' : 'delete'](entry.target);
    }, {threshold:0});
    const headingsSelector = Array.from({length: 2 }, (_,i) => `h${i+1}`).join(', ');
    const headings = document.querySelectorAll(headingsSelector);


    for (const heading of headings) observer.observe(heading);

    let curHeading = null;
    window.addEventListener('scroll', e => {
      let minBelow = [Infinity,null];
      for (const heading of visibleHeadings) {
        const b = heading.getBoundingClientRect().bottom;
        if (b < minBelow[0]) minBelow = [b,heading];
      }
      if (minBelow[1] !== curHeading) {
        if (minBelow[1] && curHeading) {
          document.querySelector(`a[href="#${curHeading.id}"]`).classList.remove('highlight');
        }
        if (minBelow[1]) {
          curHeading = minBelow[1];
          document.querySelector(`a[href="#${curHeading.id}"]`).classList.add('highlight');
        }
      }
    });

  /* Initialize cache _translate to 0 */
  for (const focuser of document.querySelectorAll('.codewrap')) {
    focuser._translate = 0;
  }

  /* Loop through all codewraps. Treat codewraps before t (which is a codewrap)
  * in reverse order. Stack codewraps above and below t. */
  const focus = (t) => {
    const wsy = window.scrollY; // cache value for performance, big difference in chrome
    let isBefore = true;
    const tBounds = bounds(t,wsy);
    let prevBottom = tBounds.bottom - t._translate;
    let prevTop = tBounds.top - t._translate;
    t._translate = 0;
    let befores = [];
    // apply changes after t from t downwards
    for (const cur of document.querySelectorAll(".codewrap")) {
      if (cur === t) {
        isBefore = false;
      } else if (isBefore) {
        befores.push(cur);
      } else {
        const cBounds = bounds(cur,wsy);
        const _translate = prevBottom - cBounds.top;
        cur._translate = cur._translate + _translate;
        prevBottom = prevBottom + (cBounds.bottom - cBounds.top);
      }
    }

    // apply changes before t from t upwards
    let cur;
    while ((cur = befores.pop())) {
      const cBounds = bounds(cur,wsy);
      const _translate = prevTop - cBounds.bottom;
      cur._translate = cur._translate + _translate;
      prevTop = prevTop - (cBounds.bottom - cBounds.top);
    }

    // batch changes after reading layout to avoid layout thrashing
    for (const cur of document.querySelectorAll('.codewrap')) {
      cur.style.transform = `translate(0px,${cur._translate}px)`;
    }

  };

  /* Stop focusing */
  let currentFocuser;

  const defocus = () => {
    currentFocuser.parentNode.classList.remove("focusing");
    document.body.classList.remove('bodyFocusing');
    currentFocuser = undefined;
    for (const t of document.querySelectorAll(".codewrap")) {
      t.style.transform = "translate(0px,0px)";
      t._translate = 0;
    }
  };

  /* Defocus when clicking anywhere and currently in focus */
  document.body.addEventListener('click', e => {
    if (currentFocuser) defocus();
  });

  /* Focus when clicking a focuser. Disabled when in focus.  */
  for (const focuser of document.querySelectorAll('.focuser')) {
    focuser.addEventListener('click', e => {
      if (currentFocuser) return;
      currentFocuser = e.currentTarget;
      focus(currentFocuser.parentNode.querySelector('.codewrap'));
      currentFocuser.parentNode.classList.add("focusing");
      document.body.classList.add('bodyFocusing');
      e.stopPropagation();
    });
  }

  /* Avoid horizontal scrolling when clicking on internal anchors */
  let scrollHighlighted = null;

  const doScroll = target => target.scrollIntoView({behavior: "auto", block: "start", inline: "end"});

  for (const anchor of document.querySelectorAll("a[href^='#']")) {
    anchor.addEventListener('click', e => {
      e.preventDefault();
      history.pushState(null, null, anchor.getAttribute('href'));
      // Must use [id=] syntax instead of # syntax to escape forward slash in anchor name.
      const target = document.querySelector(`[id='${anchor.getAttribute("href").slice(1)}']`);
      if (scrollHighlighted) {
        scrollHighlighted.classList.remove('scrollHighlighted');
      }
      scrollHighlighted = target.closest('.level');
      if (scrollHighlighted) {
        doScroll(scrollHighlighted);
        scrollHighlighted.classList.add('scrollHighlighted');
      } else {
        doScroll(target);
      }
    });
  };
});
</script>
</head>
  <body>
    <nav>
      <a href="#structs.js" class="toc-file">structs.js</a>
      <a href="#structs.js-mangrove-summary" class="toc-h1">Mangrove Summary</a>
      <a href="#structs.js-data-stuctures" class="toc-h1">Data stuctures</a>
      <a href="#structs.js-structs" class="toc-h1">Structs</a>
      <a href="#structs.js-offer" class="toc-h2">Offer</a>
      <a href="#structs.js-offerdetail" class="toc-h2">OfferDetail</a>
      <a href="#structs.js-configuration-and-state" class="toc-h2">Configuration and state</a>
      <a href="#structs.js-example" class="toc-h1">Example</a>
      <a href="#mgvlib.sol" class="toc-file">MgvLib.sol</a>
      <a href="#mgvlib.sol-structs-0" class="toc-h1">Structs</a>
      <a href="#mgvlib.sol-events" class="toc-h1">Events</a>
      <a href="#mgvlib.sol-imaker-interface" class="toc-h1">IMaker interface</a>
      <a href="#mgvlib.sol-itaker-interface" class="toc-h1">ITaker interface</a>
      <a href="#mgvlib.sol-monitor-interface" class="toc-h1">Monitor interface</a>
      <a href="#mgvroot.sol" class="toc-file">MgvRoot.sol</a>
      <a href="#mgvroot.sol-state-variables" class="toc-h1">State variables</a>
      <a href="#mgvroot.sol-configuration-reads" class="toc-h1">Configuration Reads</a>
      <a href="#mgvroot.sol-gatekeeping" class="toc-h1">Gatekeeping</a>
      <a href="#mgvhasoffers.sol" class="toc-file">MgvHasOffers.sol</a>
      <a href="#mgvhasoffers.sol-state-variables-0" class="toc-h1">State variables</a>
      <a href="#mgvhasoffers.sol-read-functions" class="toc-h1">Read functions</a>
      <a href="#mgvhasoffers.sol-provision-debit%2Fcredit-utility-functions" class="toc-h1">Provision debit/credit utility functions</a>
      <a href="#mgvhasoffers.sol-misc.-low-level-functions" class="toc-h1">Misc. low-level functions</a>
      <a href="#mgvhasoffers.sol-offer-deletion" class="toc-h2">Offer deletion</a>
      <a href="#mgvhasoffers.sol-stitching-the-orderbook" class="toc-h2">Stitching the orderbook</a>
      <a href="#mgvhasoffers.sol-check-offer-is-live" class="toc-h2">Check offer is live</a>
      <a href="#mgvoffermaking.sol" class="toc-file">MgvOfferMaking.sol</a>
      <a href="#mgvoffermaking.sol-public-maker-operations" class="toc-h1">Public Maker operations</a>
      <a href="#mgvoffermaking.sol-new-offer" class="toc-h2">New Offer</a>
      <a href="#mgvoffermaking.sol-update-offer" class="toc-h2">Update Offer</a>
      <a href="#mgvoffermaking.sol-retract-offer" class="toc-h2">Retract Offer</a>
      <a href="#mgvoffermaking.sol-provisioning" class="toc-h2">Provisioning</a>
      <a href="#mgvoffermaking.sol-low-level-maker-functions" class="toc-h1">Low-level Maker functions</a>
      <a href="#mgvoffermaking.sol-write-offer" class="toc-h2">Write Offer</a>
      <a href="#mgvoffermaking.sol-find-position" class="toc-h2">Find Position</a>
      <a href="#mgvoffermaking.sol-better" class="toc-h2">Better</a>
      <a href="#mgvoffertaking.sol" class="toc-file">MgvOfferTaking.sol</a>
      <a href="#mgvoffertaking.sol-multiorder-struct" class="toc-h1">MultiOrder struct</a>
      <a href="#mgvoffertaking.sol-market-orders" class="toc-h1">Market Orders</a>
      <a href="#mgvoffertaking.sol-market-order" class="toc-h2">Market Order</a>
      <a href="#mgvoffertaking.sol-general-market-order" class="toc-h1">General Market Order</a>
      <a href="#mgvoffertaking.sol-internal-market-order" class="toc-h2">Internal market order</a>
      <a href="#mgvoffertaking.sol-sniping" class="toc-h1">Sniping</a>
      <a href="#mgvoffertaking.sol-snipes" class="toc-h2">Snipes</a>
      <a href="#mgvoffertaking.sol-internal-snipes" class="toc-h2">Internal snipes</a>
      <a href="#mgvoffertaking.sol-general-execution" class="toc-h1">General execution</a>
      <a href="#mgvoffertaking.sol-execute" class="toc-h2">Execute</a>
      <a href="#mgvoffertaking.sol-flashloan-(abstract)" class="toc-h2">flashloan (abstract)</a>
      <a href="#mgvoffertaking.sol-maker-execute" class="toc-h2">Maker Execute</a>
      <a href="#mgvoffertaking.sol-executeend-(abstract)" class="toc-h2">executeEnd (abstract)</a>
      <a href="#mgvoffertaking.sol-post-execute" class="toc-h2">Post execute</a>
      <a href="#mgvoffertaking.sol-beforeposthook-(abstract)" class="toc-h2">beforePosthook (abstract)</a>
      <a href="#mgvoffertaking.sol-maker-posthook" class="toc-h2">Maker Posthook</a>
      <a href="#mgvoffertaking.sol-controlledcall" class="toc-h2">controlledCall</a>
      <a href="#mgvoffertaking.sol-penalties" class="toc-h1">Penalties</a>
      <a href="#mgvoffertaking.sol-misc.-functions" class="toc-h1">Misc. functions</a>
      <a href="#mgvoffertakingwithpermit.sol" class="toc-file">MgvOfferTakingWithPermit.sol</a>
      <a href="#mgvoffertakingwithpermit.sol-delegation-public-functions" class="toc-h1">Delegation public functions</a>
      <a href="#mgvoffertakingwithpermit.sol-misc.-low-level-functions-0" class="toc-h1">Misc. low-level functions</a>
      <a href="#mgvgovernable.sol" class="toc-file">MgvGovernable.sol</a>
      <a href="#mgvgovernable.sol-authonly-check" class="toc-h2">authOnly check</a>
      <a href="#mgvgovernable.sol-set-configuration-and-mangrove-state" class="toc-h1">Set configuration and Mangrove state</a>
      <a href="#mgvgovernable.sol-locals" class="toc-h2">Locals</a>
      <a href="#mgvgovernable.sol-globals" class="toc-h2">Globals</a>
      <a href="#abstractmangrove.sol" class="toc-file">AbstractMangrove.sol</a>
      <a href="#mangrove.sol" class="toc-file">Mangrove.sol</a>
      <a href="#mangrove.sol-flashloan" class="toc-h2">Flashloan</a>
      <a href="#invertedmangrove.sol" class="toc-file">InvertedMangrove.sol</a>
      <a href="#invertedmangrove.sol-flashloans" class="toc-h1">Flashloans</a>
      <a href="#invertedmangrove.sol-inverted-flashloan" class="toc-h2">Inverted Flashloan</a>
    </nav>
    <main>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="structs.js" class="left filebreak">structs.js</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="structs.js-mangrove-summary">Mangrove Summary</h1>
<ul>
<li>The Mangrove holds offer books for <code>outbound_tkn</code>,<code>inbound_tkn</code> pairs.</li>
<li>Offers are sorted in a doubly linked list.</li>
<li>Each offer promises <code>outbound_tkn</code> and requests <code>inbound_tkn</code>.</li>
<li>Each offer has an attached <code>maker</code> address.</li>
<li>In the normal operation mode (called Mangrove for Maker Mangrove), when an offer is executed, we:
<ol>
<li>Flashloan some <code>inbound_tkn</code> to the offer’s <code>maker</code>.</li>
<li>Call an arbitrary <code>execute</code> function on that address.</li>
<li>Transfer back some <code>outbound_tkn</code>.</li>
<li>Call back the <code>maker</code> so they can update their offers.</li>
</ol>
</li>
<li>There is an inverted operation mode (called InvertedMangrove for Taker Mangrove), the flashloan is reversed (from the maker to the taker).</li>
<li>Offer are just promises. They can fail.</li>
<li>If an offer fails to transfer the right amount back, the loan is reverted.</li>
<li>A penalty mechanism incentivizes keepers to keep the book clean of failing offers.</li>
<li>A penalty provision must be posted with each offer.</li>
<li>If the offer succeeds, the provision returns to the maker.</li>
<li>If the offer fails, the provision is given to the taker as penalty.</li>
<li>The penalty should overcompensate for the taker’s lost gas.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="structs.js-data-stuctures">Data stuctures</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Struct-like data structures are stored in storage and memory as 256 bits words. We avoid using structs due to significant gas savings gained by extracting data from words only when needed. To make development easier, we use the preprocessor <code>solpp</code> and generate getters and setters for each struct we declare. The generation is defined in <code>lib/preproc.js</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>25
26
27</pre></code>
          <pre>
<span class="token keyword">const</span> preproc <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./lib/preproc.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Struct fields that are common to multiple structs are factored here. Multiple field names refer to offer identifiers, so the <code>id</code> field is a function that takes a name as argument.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></code>
          <pre>
<span class="token keyword">const</span> fields <span class="token operator">=</span> <span class="token punctuation">{</span>
  wants<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"wants"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">96</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  gives<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"gives"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">96</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  gasprice<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"gasprice"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  gasreq<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"gasreq"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  overhead_gasbase<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"overhead_gasbase"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  offer_gasbase<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"offer_gasbase"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">id_field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="structs.js-structs">Structs</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="structs.js-offer"><code>Offer</code></h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>Offer</code>s hold the doubly-linked list pointers as well as price and volume information. 256 bits wide, so one storage read is enough. They have the following fields:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>49
50</pre></code>
          <pre><span class="token keyword">const</span> structs <span class="token operator">=</span> <span class="token punctuation">{</span>
  offer<span class="token operator">:</span> <span class="token punctuation">[</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>prev</code> points to immediately better offer. The best offer’s <code>prev</code> is 0. <em>24 bits wide</em>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>52
53</pre></code>
          <pre>
    <span class="token function">id_field</span><span class="token punctuation">(</span><span class="token string">"prev"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>next</code> points to the immediately worse offer. The worst offer’s <code>next</code> is 0. <em>24 bits wide</em>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>55</pre></code>
          <pre>    <span class="token function">id_field</span><span class="token punctuation">(</span><span class="token string">"next"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>wants</code> is the amount of <code>inbound_tkn</code> the offer wants in exchange for <code>gives</code>.
<em>96 bits wide</em>, so assuming the usual 18 decimals, amounts can only go up to
10 billions.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>59</pre></code>
          <pre>    fields<span class="token punctuation">.</span>wants<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>gives</code> is the amount of <code>outbound_tkn</code> the offer will give if successfully executed.
<em>96 bits wide</em>, so assuming the usual 18 decimals, amounts can only go up to
10 billions.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>63</pre></code>
          <pre>    fields<span class="token punctuation">.</span>gives<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>gasprice</code> is in gwei/gas and <em>16 bits wide</em>, which accomodates 1 to ~65k gwei / gas.  <code>gasprice</code> is also the name of a global Mangrove parameter. When an offer is created, the offer’s <code>gasprice</code> is set to the max of the user-specified <code>gasprice</code> and the Mangrove’s global <code>gasprice</code>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>65
66
67</pre></code>
          <pre>    fields<span class="token punctuation">.</span>gasprice<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="structs.js-offerdetail"><code>OfferDetail</code></h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>OfferDetail</code>s hold the maker’s address and provision/penalty-related information.
They have the following fields:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>72</pre></code>
          <pre>  offerDetail<span class="token operator">:</span> <span class="token punctuation">[</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>maker</code> is the address that created the offer. It will be called when the offer is executed, and later during the posthook phase.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>74</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"maker"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">160</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"address"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><a id="structs.js/gasreq"></a><code>gasreq</code> gas will be provided to <code>execute</code>. <em>24 bits wide</em>, 33% more than the block limit as of late 2020. Note that if more room was needed, we could bring it down to 16 bits and have it represent 1k gas increments.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>78</pre></code>
          <pre>    fields<span class="token punctuation">.</span>gasreq<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><a id="structs.js/gasbase"></a><code>overhead_gasbase</code> represents the gas used by initiating an entire order (snipes or market order).</li>
<li><code>offer_gasbase</code> represents the gas overhead used by processing the offer inside the Mangrove.</li>
</ul>
<p>The gas considered ‘used’ by an offer is the sum of</p>
<ul>
<li>gas consumed during the call to the offer</li>
<li><code>offer_gasbase</code></li>
<li><code>overhead_gasbase/n</code>, where <code>n</code> is the number of offers that failed during the entire order</li>
</ul>
<p>If an offer fails, <code>gasprice</code> wei is taken from the
provision per unit of gas used. <code>gasprice</code> should approximate the average gas
price at offer creation time.</p>
<p><code>overhead_gasbase</code> and <code>offer_gasbase</code> are <em>24 bits wide</em> – note that if more room was needed, we could bring them down to 8 bits and have it represent 1k gas increments.</p>
<p><code>overhead_gasbase</code> and <code>offer_gasbase</code> are also the names of global Mangrove
parameters. When an offer is created, their current value is copied from the Mangrove global configuration.  The maker does not choose it.</p>
<p>So, when an offer is created, the maker is asked to provision the
following amount of wei:</p>
<pre><code>(gasreq + offer_gasbase + overhead_gasbase) * gasprice
</code></pre>
<p>where <code>overhead_gasbase</code>, <code>offer_gasbase</code> and <code>gasprice</code> are the Mangrove’s current configuration values (or a higher value for <code>gasprice</code> if specified by the maker).</p>
<p>When an offer fails, the following amount is given to the taker as compensation:</p>
<pre><code>(gasused + offer_gasbase + overhead_gasbase/n) * gasprice
</code></pre>
<p>where <code>n</code> is the number of failing offers, and <code>overhead_gasbase</code>, <code>offer_gasbase</code>, and <code>gasprice</code> are the Mangrove’s current configuration values.  The rest is given back to the maker.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>114
115
116
117</pre></code>
          <pre>    fields<span class="token punctuation">.</span>overhead_gasbase<span class="token punctuation">,</span>
    fields<span class="token punctuation">.</span>offer_gasbase<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="structs.js-configuration-and-state">Configuration and state</h2>
<p>Configuration information for a <code>outbound_tkn</code>,<code>inbound_tkn</code> pair is split between a <code>global</code> struct (common to all pairs) and a <code>local</code> struct specific to each pair. Configuration fields are:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Global Configuration</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>122</pre></code>
          <pre>  global<span class="token operator">:</span> <span class="token punctuation">[</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>The <code>monitor</code> can provide realtime values for <code>gasprice</code> and <code>density</code> to the dex, and receive liquidity events notifications.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>124</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"monitor"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">160</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"address"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>If <code>useOracle</code> is true, the dex will use the monitor address as an oracle for <code>gasprice</code> and <code>density</code>, for every outbound_tkn/inbound_tkn pair.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>126</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"useOracle"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>If <code>notify</code> is true, the dex will notify the monitor address after every offer execution.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>128</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"notify"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>The <code>gasprice</code> is the amount of penalty paid by failed offers, in gwei per gas used. <code>gasprice</code> should approximate the average gas price and will be subject to regular updates.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>130</pre></code>
          <pre>    fields<span class="token punctuation">.</span>gasprice<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>gasmax</code> specifies how much gas an offer may ask for at execution time. An offer which asks for more gas than the block limit would live forever on the book. Nobody could take it or remove it, except its creator (who could cancel it). In practice, we will set this parameter to a reasonable limit taking into account both practical transaction sizes and the complexity of maker contracts.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>133</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"gasmax"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>dead</code> dexes cannot be resurrected.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>135
136
137</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"dead"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Local configuration</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>139</pre></code>
          <pre>  local<span class="token operator">:</span> <span class="token punctuation">[</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>A <code>outbound_tkn</code>,<code>inbound_tkn</code> pair is in<code>active</code> by default, but may be activated/deactivated by governance.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>141</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"active"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>fee</code>, in basis points, of <code>outbound_tkn</code> given to the taker. This fee is sent to the Mangrove. Fee is capped to 5%.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>143</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"fee"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>density</code> is similar to a ‘dust’ parameter. We prevent spamming of low-volume offers by asking for a minimum ‘density’ in <code>outbound_tkn</code> per gas requested. For instance, if <code>density == 10</code>, <code>offer_gasbase == 5000</code>, <code>overhead_gasbase == 0</code>, an offer with <code>gasreq == 30000</code> must promise at least <em>10 × (30000 + 5) = 305000</em> <code>outbound_tkn</code>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>145</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"density"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>overhead_gasbase</code> is an overapproximation of the gas overhead consumed by making an order (snipes or market order). Local to a pair because the costs of paying the fee depends on the relevant ERC20 contract.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>147</pre></code>
          <pre>    fields<span class="token punctuation">.</span>overhead_gasbase<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>offer_gasbase</code> is an overapproximation of the gas overhead associated with processing one offer. The Mangrove considers that a failed offer has used at least <code>offer_gasbase</code> gas. Local to a pair because the costs of calling <code>outbound_tkn</code> and <code>inbound_tkn</code>’s <code>transferFrom</code> are part of <code>offer_gasbase</code>. Should only be updated when ERC20 contracts change or when opcode prices change.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>149</pre></code>
          <pre>    fields<span class="token punctuation">.</span>offer_gasbase<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>If <code>lock</code> is true, orders may not be added nor executed.</li>
</ul>
<p>Reentrancy during offer execution is not considered safe:</p>
<ul>
<li>during execution, an offer could consume other offers further up in the book, effectively frontrunning the taker currently executing the offer.</li>
<li>it could also cancel other offers, creating a discrepancy between the advertised and actual market price at no cost to the maker.</li>
<li>an offer insertion consumes an unbounded amount of gas (because it has to be correctly placed in the book).</li>
</ul>
<p>Note: An optimization in the <code>marketOrder</code> function relies on reentrancy being forbidden.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>159</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"lock"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>best</code> holds the current best offer id. Has size of an id field. <em>Danger</em>: reading best inside a lock may give you a stale value.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>161</pre></code>
          <pre>    <span class="token function">id_field</span><span class="token punctuation">(</span><span class="token string">"best"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>last</code> is a counter for offer ids, incremented every time a new offer is created. It can’t go above <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>24</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{24}-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>163
164
165
166</pre></code>
          <pre>    <span class="token function">id_field</span><span class="token punctuation">(</span><span class="token string">"last"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="structs.js-example">Example</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>preproc.structs_with_macros</code> generates preprocessor instruction to get/set all fields in the above structs. A preprocessor method <code>m(args)</code> is invoked in solidity code by writing <code>$$(m(args))</code>.</p>
<p>For instance, the structs object</p>
<pre><code>{
myStruct: [
 {name: &quot;a&quot;, bits: 8,  type: &quot;uint&quot;},
 {name: &quot;b&quot;, bits: 160, type: &quot;address&quot;}
]
}
</code></pre>
<p>will generate the following preprocessor macros:</p>
<ul>
<li><code>set_myStruct(ptr,values)</code>. In a context where the solidity variable <code>v</code> holds an encoded <code>myStruct</code>, it can be used with <code>$$(set_myStruct('v',[['b','msg.sender']]))</code>. Note that solidity expression are given as strings. Here : <code>$$(set_myStruct('v',[['a',256]]))</code> and in all other methods, arguments exceeding the <code>bits</code> parameter of a field will be left-truncated.</li>
<li><code>make_myStruct(values)</code>. An optimised version of <code>set_myStruct</code> where the initial value is the null word.</li>
<li><code>myStruct_a(ptr)</code>, to access the <code>a</code> field. Returns a uint. If the solidity variable <code>v</code> holds an encoded <code>myStruct</code>, it can be used with <code>$$(myStruct_a('v'))</code>.</li>
<li><code>myStruct_b(ptr)</code>, to access the <code>b</code> field. Returns an address.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>188</pre></code>
          <pre>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> preproc<span class="token punctuation">.</span><span class="token function">structs_with_macros</span><span class="token punctuation">(</span>structs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mgvlib.sol" class="left filebreak">MgvLib.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>MgvLib</code> contains data structures returned by external calls to Mangrove and the interfaces it uses for its own external calls.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>4
5
6
7</pre></code>
          <pre>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.7.0</span><span class="token punctuation">;</span>
<span class="token keyword">pragma</span> abicoder v2<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvlib.sol-structs-0">Structs</h1>
<p>The structs defined in <code>structs.js</code> have their counterpart as solidity structs that are easy to manipulate for outside contracts / callers of view functions.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre></code>
          <pre><span class="token keyword">library</span> <span class="token class-name">MgvLib</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">Offer</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint</span> prev<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> next<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> gives<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> wants<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> gasprice<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">struct</span> <span class="token class-name">OfferDetail</span> <span class="token punctuation">{</span>
    <span class="token builtin">address</span> maker<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> gasreq<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> overhead_gasbase<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> offer_gasbase<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">struct</span> <span class="token class-name">Global</span> <span class="token punctuation">{</span>
    <span class="token builtin">address</span> monitor<span class="token punctuation">;</span>
    <span class="token builtin">bool</span> useOracle<span class="token punctuation">;</span>
    <span class="token builtin">bool</span> notify<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> gasprice<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> gasmax<span class="token punctuation">;</span>
    <span class="token builtin">bool</span> dead<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">struct</span> <span class="token class-name">Local</span> <span class="token punctuation">{</span>
    <span class="token builtin">bool</span> active<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> fee<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> density<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> overhead_gasbase<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> offer_gasbase<span class="token punctuation">;</span>
    <span class="token builtin">bool</span> lock<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> best<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> last<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Some miscellaneous data types useful to <code>Mangrove</code> and external contracts</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>SingleOrder</code> holds data about an order-offer match in a struct. Used by <code>marketOrder</code> and <code>internalSnipes</code> (and some of their nested functions) to avoid stack too deep errors.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>50
51
52
53
54</pre></code>
          <pre>  <span class="token keyword">struct</span> <span class="token class-name">SingleOrder</span> <span class="token punctuation">{</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">;</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> offerId<span class="token punctuation">;</span>
    <span class="token builtin">bytes32</span> offer<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>wants</code>/<code>gives</code> mutate over execution. Initially the <code>wants</code>/<code>gives</code> from the taker’s pov, then actual <code>wants</code>/<code>gives</code> adjusted by offer’s price and volume.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>56
57</pre></code>
          <pre>    <span class="token builtin">uint</span> wants<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> gives<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>offerDetail</code> is only populated when necessary.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>59
60
61
62
63</pre></code>
          <pre>    <span class="token builtin">bytes32</span> offerDetail<span class="token punctuation">;</span>
    <span class="token builtin">bytes32</span> global<span class="token punctuation">;</span>
    <span class="token builtin">bytes32</span> local<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="MgvLib/OrderResult"></a> <code>OrderResult</code> holds additional data for the maker and is given to them <em>after</em> they fulfilled an offer. It gives them their own returned data from the previous call, and an <code>mgvData</code> specifying whether the Mangrove encountered an error.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>65
66</pre></code>
          <pre>
  <span class="token keyword">struct</span> <span class="token class-name">OrderResult</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>makerdata</code> holds a message that was either returned by the maker or passed as revert message at the end of the trade execution</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>68</pre></code>
          <pre>    <span class="token builtin">bytes32</span> makerData<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>mgvData</code> is an <a href="#MgvOfferTaking/statusCodes">internal Mangrove status</a> code.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>70
71
72
73</pre></code>
          <pre>    <span class="token builtin">bytes32</span> mgvData<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvlib.sol-events">Events</h1>
<p>The events emitted for use by bots are listed here:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>76</pre></code>
          <pre><span class="token keyword">contract</span> <span class="token class-name">HasMgvEvents</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Emitted at the creation of the new Mangrove contract on the pair (<code>inbound_tkn</code>, <code>outbound_tkn</code>)</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>78
79</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">NewMgv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Mangrove adds or removes wei from <code>maker</code>’s account</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Credit event occurs when an offer is removed from the Mangrove or when the <code>fund</code> function is called</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>82</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">Credit</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> maker<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Debit event occurs when an offer is posted or when the <code>withdraw</code> function is called</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>84
85</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">Debit</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> maker<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Mangrove reconfiguration</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">SetActive</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">bool</span> value
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">event</span> <span class="token function">SetFee</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> value
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">event</span> <span class="token function">SetGasbase</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> overhead_gasbase<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> offer_gasbase
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">event</span> <span class="token function">SetGovernance</span><span class="token punctuation">(</span><span class="token builtin">address</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">event</span> <span class="token function">SetMonitor</span><span class="token punctuation">(</span><span class="token builtin">address</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">event</span> <span class="token function">SetVault</span><span class="token punctuation">(</span><span class="token builtin">address</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">event</span> <span class="token function">SetUseOracle</span><span class="token punctuation">(</span><span class="token builtin">bool</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">event</span> <span class="token function">SetNotify</span><span class="token punctuation">(</span><span class="token builtin">bool</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">event</span> <span class="token function">SetGasmax</span><span class="token punctuation">(</span><span class="token builtin">uint</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">event</span> <span class="token function">SetDensity</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> value
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">event</span> <span class="token function">SetGasprice</span><span class="token punctuation">(</span><span class="token builtin">uint</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Market order execution</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>117
118
119
120
121
122
123
124</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">OrderComplete</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> taker<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerGot<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerGave
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Offer execution</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>126
127
128
129</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">OfferSuccess</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> id<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><code>maker</code> is not logged because it can be retrieved from the state using <code>(outbound_tkn,inbound_tkn,id)</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>131
132
133
134
135</pre></code>
          <pre>    <span class="token builtin">address</span> taker<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerGives
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Log information when a trade execution reverts or returns a non empty bytes32 word</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>137
138
139
140</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">OfferFail</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> id<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><code>maker</code> is not logged because it can be retrieved from the state using <code>(outbound_tkn,inbound_tkn,id)</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>142
143
144</pre></code>
          <pre>    <span class="token builtin">address</span> taker<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerGives<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><code>mgvData</code> may only be <code>&quot;mgv/makerRevert&quot;</code>, <code>&quot;mgv/makerAbort&quot;</code>, <code>&quot;mgv/makerTransferFail&quot;</code> or <code>&quot;mgv/makerReceiveFail&quot;</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>146
147
148</pre></code>
          <pre>    <span class="token builtin">bytes32</span> mgvData
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Log information when a posthook reverts</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>150
151
152
153
154
155</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">PosthookFail</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> offerId
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>After <code>permit</code> and <code>approve</code></li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>157
158
159
160
161
162
163
164</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">Approval</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> owner<span class="token punctuation">,</span>
    <span class="token builtin">address</span> spender<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> value
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Mangrove closure</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>166
167</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">Kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>An offer was created or updated.
A few words about why we include a <code>prev</code> field, and why we don’t include a
<code>next</code> field: in theory clients should need neither <code>prev</code> nor a <code>next</code> field.
They could just 1. Read the order book state at a given block <code>b</code>.  2. On
every event, update a local copy of the orderbook.  But in practice, we do not
want to force clients to keep a copy of the <em>entire</em> orderbook. There may be a
long tail of spam. Now if they only start with the first <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> offers and
receive a new offer that goes to the end of the book, they cannot tell if
there are missing offers between the new offer and the end of the local copy
of the book.</li>
</ul>
<p>So we add a prev pointer so clients with only a prefix of the book can receive
out-of-prefix offers and know what to do with them. The <code>next</code> pointer is an
optimization useful in Solidity (we traverse fewer memory locations) but
useless in client code.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>184
185
186
187
188
189
190
191
192
193
194
195</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">OfferWrite</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> maker<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> wants<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gives<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasreq<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> id<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> prev
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>offerId</code> was present and is now removed from the book.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>197
198
199
200
201
202
203</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">OfferRetract</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> id
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvlib.sol-imaker-interface">IMaker interface</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>205</pre></code>
          <pre><span class="token keyword">interface</span> <span class="token class-name">IMaker</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Called upon offer execution. If the call returns normally with the first 32 bytes are 0, Mangrove will try to transfer funds; otherwise not. Returned data (truncated to leftmost 32 bytes) can be accessed during the call to <code>makerPosthook</code> in the <code>result.mgvData</code> field. To revert with a 32 bytes value, use something like:</p>
<pre><code>function tradeRevert(bytes32 data) internal pure {
  bytes memory revData = new bytes(32);
    assembly {
      mstore(add(revData, 32), data)
      revert(add(revData, 32), 32)
    }
}
</code></pre>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>217
218
219
220</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">makerExecute</span><span class="token punctuation">(</span>MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> order<span class="token punctuation">)</span>
    <span class="token keyword">external</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Called after all offers of an order have been executed. Posthook of the last executed order is called first and full reentrancy into the Mangrove is enabled at this time. <code>order</code> recalls key arguments of the order that was processed and <code>result</code> recalls important information for updating the current offer. (see <a href="#MgvLib/OrderResult">above</a>)</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>222
223
224
225
226
227</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">makerPosthook</span><span class="token punctuation">(</span>
    MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> order<span class="token punctuation">,</span>
    MgvLib<span class="token punctuation">.</span>OrderResult <span class="token keyword">calldata</span> result
  <span class="token punctuation">)</span> <span class="token keyword">external</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvlib.sol-itaker-interface">ITaker interface</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>229</pre></code>
          <pre><span class="token keyword">interface</span> <span class="token class-name">ITaker</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Inverted mangrove only: call to taker after loans went through</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>231
232
233</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">takerTrade</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>total amount of outbound_tkn token that was flashloaned to the taker</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>235</pre></code>
          <pre>    <span class="token builtin">uint</span> totalGot<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>total amount of inbound_tkn token that should be made available</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>237
238
239
240</pre></code>
          <pre>    <span class="token builtin">uint</span> totalGives
  <span class="token punctuation">)</span> <span class="token keyword">external</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvlib.sol-monitor-interface">Monitor interface</h1>
<p>If enabled, the monitor receives notification after each offer execution and is read for each pair’s <code>gasprice</code> and <code>density</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279</pre></code>
          <pre><span class="token keyword">interface</span> <span class="token class-name">IMgvMonitor</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">notifySuccess</span><span class="token punctuation">(</span>MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> sor<span class="token punctuation">,</span> <span class="token builtin">address</span> taker<span class="token punctuation">)</span>
    <span class="token keyword">external</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">notifyFail</span><span class="token punctuation">(</span>MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> sor<span class="token punctuation">,</span> <span class="token builtin">address</span> taker<span class="token punctuation">)</span> <span class="token keyword">external</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span> <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">)</span>
    <span class="token keyword">external</span>
    <span class="token keyword">view</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span> <span class="token builtin">uint</span> density<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name">IERC20</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">totalSupply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span> account<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token builtin">address</span> recipient<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">allowance</span><span class="token punctuation">(</span><span class="token builtin">address</span> owner<span class="token punctuation">,</span> <span class="token builtin">address</span> spender<span class="token punctuation">)</span>
    <span class="token keyword">external</span>
    <span class="token keyword">view</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token builtin">address</span> spender<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">transferFrom</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> sender<span class="token punctuation">,</span>
    <span class="token builtin">address</span> recipient<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> amount
  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">event</span> <span class="token function">Transfer</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token builtin">address</span> <span class="token keyword">indexed</span> to<span class="token punctuation">,</span> <span class="token builtin">uint</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">event</span> <span class="token function">Approval</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> owner<span class="token punctuation">,</span> <span class="token builtin">address</span> <span class="token keyword">indexed</span> spender<span class="token punctuation">,</span> <span class="token builtin">uint</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>/ for wETH contract</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>281
282
283
284
285
286</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">deposit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">external</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">decimals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mgvroot.sol" class="left filebreak">MgvRoot.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>MgvRoot</code> and its descendants describe an orderbook-based exchange (“the Mangrove”) where market makers <em>do not have to provision their offer</em>. See <code>structs.js</code> for a longer introduction. In a nutshell: each offer created by a maker specifies an address (<code>maker</code>) to call upon offer execution by a taker. In the normal mode of operation, the Mangrove transfers the amount to be paid by the taker to the maker, calls the maker, attempts to transfer the amount promised by the maker to the taker, and reverts if it cannot.</p>
<p>There is one Mangrove contract that manages all tradeable pairs. This reduces deployment costs for new pairs and lets market makers have all their provision for all pairs in the same place.</p>
<p>The interaction map between the different actors is as follows:
<img src="./contactMap.png" width="190%"></img></p>
<p>The sequence diagram of a market order is as follows:
<img src="./sequenceChart.png" width="190%"></img></p>
<p>There is a secondary mode of operation in which the <em>maker</em> flashloans the sold amount to the taker.</p>
<p>The Mangrove contract is <code>abstract</code> and accomodates both modes. Two contracts, <code>Mangrove</code> and <code>InvertedMangrove</code> inherit from it, one per mode of operation.</p>
<p>The contract structure is as follows:
<img src="./modular_mangrove.svg" width="180%"> </img></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>19
20
21
22
23</pre></code>
          <pre>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.7.0</span><span class="token punctuation">;</span>
<span class="token keyword">pragma</span> abicoder v2<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvLib <span class="token keyword">as</span> ML<span class="token punctuation">,</span> HasMgvEvents<span class="token punctuation">,</span> IMgvMonitor<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvLib.sol"</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>MgvRoot</code> contains state variables used everywhere in the operation of the Mangrove and their related function.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>25</pre></code>
          <pre><span class="token keyword">contract</span> <span class="token class-name">MgvRoot</span> <span class="token keyword">is</span> HasMgvEvents <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvroot.sol-state-variables">State variables</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The <code>vault</code> address. If a pair has fees &gt;0, those fees are sent to the vault.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>29
30</pre></code>
          <pre>  <span class="token builtin">address</span> <span class="token keyword">public</span> vault<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Global mgv configuration, encoded in a 256 bits word. The information encoded is detailed in <a href="#structs.js"><code>structs.js</code></a>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>32</pre></code>
          <pre>  <span class="token builtin">bytes32</span> <span class="token keyword">internal</span> global<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Configuration mapping for each token pair of the form <code>outbound_tkn =&gt; inbound_tkn =&gt; bytes32</code>. The structure of each <code>bytes32</code> value is detailed in <a href="#structs.js"><code>structs.js</code></a>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>34
35</pre></code>
          <pre>  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">bytes32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">internal</span> locals<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Checking the size of <code>density</code> is necessary to prevent overflow when <code>density</code> is used in calculations.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>37
38
39
40</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">checkDensity</span><span class="token punctuation">(</span><span class="token builtin">uint</span> density<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token builtin">uint32</span><span class="token punctuation">(</span>density<span class="token punctuation">)</span> <span class="token operator">==</span> density<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Checking the size of <code>gasprice</code> is necessary to prevent a) data loss when <code>gasprice</code> is copied to an <code>OfferDetail</code> struct, and b) overflow when <code>gasprice</code> is used in calculations.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>42
43
44
45</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">checkGasprice</span><span class="token punctuation">(</span><span class="token builtin">uint</span> gasprice<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token builtin">uint16</span><span class="token punctuation">(</span>gasprice<span class="token punctuation">)</span> <span class="token operator">==</span> gasprice<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvroot.sol-configuration-reads">Configuration Reads</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Reading the configuration for a pair involves reading the config global to all pairs and the local one. In addition, a global parameter (<code>gasprice</code>) and a local one (<code>density</code>) may be read from the oracle.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span> <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">)</span>
    <span class="token keyword">public</span>
    <span class="token keyword">view</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes32</span> _global<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> _local<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    _global <span class="token operator">=</span> global<span class="token punctuation">;</span>
    _local <span class="token operator">=</span> locals<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">global_useOracle</span><span class="token punctuation">(</span><span class="token string">"_global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span> <span class="token builtin">uint</span> density<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">IMgvMonitor</span><span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">global_monitor</span><span class="token punctuation">(</span><span class="token string">"_global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkGasprice</span><span class="token punctuation">(</span>gasprice<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _global <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_global</span><span class="token punctuation">(</span><span class="token string">"_global"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"gasprice"</span><span class="token punctuation">,</span> <span class="token string">"gasprice"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkDensity</span><span class="token punctuation">(</span>density<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _local <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"_local"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"density"</span><span class="token punctuation">,</span> <span class="token string">"density"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Convenience function to check whether given pair is locked</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>68
69
70
71
72
73
74
75
76</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">locked</span><span class="token punctuation">(</span><span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span> <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">)</span>
    <span class="token keyword">external</span>
    <span class="token keyword">view</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token builtin">bytes32</span> local <span class="token operator">=</span> locals<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> $$<span class="token punctuation">(</span><span class="token function">local_lock</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvroot.sol-gatekeeping">Gatekeeping</h1>
<p>Gatekeeping functions are safety checks called in various places.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>unlockedMarketOnly</code> protects modifying the market while an order is in progress. Since external contracts are called during orders, allowing reentrancy would, for instance, let a market maker replace offers currently on the book with worse ones. Note that the external contracts <em>will</em> be called again after the order is complete, this time without any lock on the market.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>84
85
86
87</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">unlockedMarketOnly</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> local<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token punctuation">{</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">local_lock</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"mgv/reentrancyLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="Mangrove/definition/liveMgvOnly"></a>
In case of emergency, the Mangrove can be <code>kill</code>ed. It cannot be resurrected. When a Mangrove is dead, the following operations are disabled :</p>
<ul>
<li>Executing an offer</li>
<li>Sending ETH to the Mangrove the normal way. Usual <a href="https://medium.com/@alexsherbuck/two-ways-to-force-ether-into-a-contract-1543c1311c56">shenanigans</a> are possible.</li>
<li>Creating a new offer</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>94
95
96
97</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">liveMgvOnly</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _global<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token punctuation">{</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">global_dead</span><span class="token punctuation">(</span><span class="token string">"_global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"mgv/dead"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>When the Mangrove is deployed, all pairs are inactive by default (since <code>locals[outbound_tkn][inbound_tkn]</code> is 0 by default). Offers on inactive pairs cannot be taken or created. They can be updated and retracted.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>99
100
101
102
103</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">activeMarketOnly</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _global<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> _local<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token punctuation">{</span>
    <span class="token function">liveMgvOnly</span><span class="token punctuation">(</span>_global<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">local_active</span><span class="token punctuation">(</span><span class="token string">"_local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"mgv/inactive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mgvhasoffers.sol" class="left filebreak">MgvHasOffers.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7</pre></code>
          <pre>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.7.0</span><span class="token punctuation">;</span>
<span class="token keyword">pragma</span> abicoder v2<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvLib <span class="token keyword">as</span> ML<span class="token punctuation">,</span> HasMgvEvents<span class="token punctuation">,</span> IMgvMonitor<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvRoot<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvRoot.sol"</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>MgvHasOffers</code> contains the state variables and functions common to both market-maker operations and market-taker operations. Mostly: storing offers, removing them, updating market makers’ provisions.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>9</pre></code>
          <pre><span class="token keyword">contract</span> <span class="token class-name">MgvHasOffers</span> <span class="token keyword">is</span> MgvRoot <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvhasoffers.sol-state-variables-0">State variables</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Given a <code>outbound_tkn</code>,<code>inbound_tkn</code> pair, the mappings <code>offers</code> and <code>offerDetails</code> associate two 256 bits words to each offer id. Those words encode information detailed in <a href="#structs.js"><code>structs.js</code></a>.</p>
<p>The mappings are <code>outbound_tkn =&gt; inbound_tkn =&gt; offerId =&gt; bytes32</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>15
16
17
18
19</pre></code>
          <pre>  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint</span> <span class="token operator">=></span> <span class="token builtin">bytes32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> offers<span class="token punctuation">;</span>
  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint</span> <span class="token operator">=></span> <span class="token builtin">bytes32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> offerDetails<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Makers provision their possible penalties in the <code>balanceOf</code> mapping.</p>
<p>Offers specify the amount of gas they require for successful execution (<a href="#structs.js/gasreq"><code>gasreq</code></a>). To minimize book spamming, market makers must provision a <em>penalty</em>, which depends on their <code>gasreq</code> and on the pair’s <a href="#structs.js/gasbase"><code>*_gasbase</code></a>. This provision is deducted from their <code>balanceOf</code>. If an offer fails, part of that provision is given to the taker, as retribution. The exact amount depends on the gas used by the offer before failing.</p>
<p>The Mangrove keeps track of their available balance in the <code>balanceOf</code> map, which is decremented every time a maker creates a new offer, and may be modified on offer updates/cancelations/takings.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>26
27</pre></code>
          <pre>  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">public</span> balanceOf<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvhasoffers.sol-read-functions">Read functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Convenience function to get best offer of the given pair</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>30
31
32
33
34
35
36
37
38</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">best</span><span class="token punctuation">(</span><span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span> <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">)</span>
    <span class="token keyword">external</span>
    <span class="token keyword">view</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token builtin">bytes32</span> local <span class="token operator">=</span> locals<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> $$<span class="token punctuation">(</span><span class="token function">local_best</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns information about an offer in ABI-compatible structs. Do not use internally, would be a huge memory-copying waste. Use <code>offers[outbound_tkn][inbound_tkn]</code> and <code>offerDetails[outbound_tkn][inbound_tkn]</code> instead.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">offerInfo</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> offerId
  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>ML<span class="token punctuation">.</span>Offer <span class="token keyword">memory</span><span class="token punctuation">,</span> ML<span class="token punctuation">.</span>OfferDetail <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">bytes32</span> offer <span class="token operator">=</span> offers<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    ML<span class="token punctuation">.</span>Offer <span class="token keyword">memory</span> offerStruct <span class="token operator">=</span> ML<span class="token punctuation">.</span><span class="token function">Offer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      prev<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offer_prev</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      next<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offer_next</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      wants<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offer_wants</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      gives<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offer_gives</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      gasprice<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offer_gasprice</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">bytes32</span> offerDetail <span class="token operator">=</span> offerDetails<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span>

    ML<span class="token punctuation">.</span>OfferDetail <span class="token keyword">memory</span> offerDetailStruct <span class="token operator">=</span> ML<span class="token punctuation">.</span><span class="token function">OfferDetail</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      maker<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_maker</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      gasreq<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      overhead_gasbase<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      offer_gasbase<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>offerStruct<span class="token punctuation">,</span> offerDetailStruct<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvhasoffers.sol-provision-debit%2Fcredit-utility-functions">Provision debit/credit utility functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>balanceOf</code> is in wei of ETH.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>67
68
69
70
71
72
73
74
75
76
77
78
79</pre></code>
          <pre>
  <span class="token keyword">function</span> <span class="token function">debitWei</span><span class="token punctuation">(</span><span class="token builtin">address</span> maker<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint</span> makerBalance <span class="token operator">=</span> balanceOf<span class="token punctuation">[</span>maker<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>makerBalance <span class="token operator">>=</span> amount<span class="token punctuation">,</span> <span class="token string">"mgv/insufficientProvision"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    balanceOf<span class="token punctuation">[</span>maker<span class="token punctuation">]</span> <span class="token operator">=</span> makerBalance <span class="token operator">-</span> amount<span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">Debit</span><span class="token punctuation">(</span>maker<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">creditWei</span><span class="token punctuation">(</span><span class="token builtin">address</span> maker<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    balanceOf<span class="token punctuation">[</span>maker<span class="token punctuation">]</span> <span class="token operator">+=</span> amount<span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">Credit</span><span class="token punctuation">(</span>maker<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvhasoffers.sol-misc.-low-level-functions">Misc. low-level functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvhasoffers.sol-offer-deletion">Offer deletion</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>When an offer is deleted, it is marked as such by setting <code>gives</code> to 0. Note that provision accounting in the Mangrove aims to minimize writes. Each maker <code>fund</code>s the Mangrove to increase its balance. When an offer is created/updated, we compute how much should be reserved to pay for possible penalties. That amount can always be recomputed with <code>offer.gasprice * (offerDetail.gasreq + offerDetail.overhead_gasbase + offerDetail.offer_gasbase)</code>. The balance is updated to reflect the remaining available ethers.</p>
<p>Now, when an offer is deleted, the offer can stay provisioned, or be <code>deprovision</code>ed. In the latter case, we set <code>gasprice</code> to 0, which induces a provision of 0. All code calling <code>dirtyDeleteOffer</code> with <code>deprovision</code> set to <code>true</code> must be careful to correctly account for where that provision is going (back to the maker’s <code>balanceOf</code>, or sent to a taker as compensation).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>86
87
88
89
90
91
92
93
94
95
96
97
98
99</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">dirtyDeleteOffer</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> offerId<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> offer<span class="token punctuation">,</span>
    <span class="token builtin">bool</span> deprovision
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    offer <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_offer</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"gives"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>deprovision<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      offer <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_offer</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"gasprice"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    offers<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>offerId<span class="token punctuation">]</span> <span class="token operator">=</span> offer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvhasoffers.sol-stitching-the-orderbook">Stitching the orderbook</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Connect the offers <code>betterId</code> and <code>worseId</code> through their <code>next</code>/<code>prev</code> pointers. For more on the book structure, see <a href="#structs.js"><code>structs.js</code></a>. Used after executing an offer (or a segment of offers), after removing an offer, or moving an offer.</p>
<p><strong>Warning</strong>: calling with <code>betterId = 0</code> will set <code>worseId</code> as the best. So with <code>betterId = 0</code> and <code>worseId = 0</code>, it sets the book to empty and loses track of existing offers.</p>
<p><strong>Warning</strong>: may make memory copy of <code>local.best</code> stale. Returns new <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">stitchOffers</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> betterId<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> worseId<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> local
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>betterId <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      offers<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>betterId<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span>
        <span class="token function">set_offer</span><span class="token punctuation">(</span>
          <span class="token string">"offers[outbound_tkn][inbound_tkn][betterId]"</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"next"</span><span class="token punctuation">,</span> <span class="token string">"worseId"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      local <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"best"</span><span class="token punctuation">,</span> <span class="token string">"worseId"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>worseId <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      offers<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>worseId<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span>
        <span class="token function">set_offer</span><span class="token punctuation">(</span>
          <span class="token string">"offers[outbound_tkn][inbound_tkn][worseId]"</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"prev"</span><span class="token punctuation">,</span> <span class="token string">"betterId"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> local<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvhasoffers.sol-check-offer-is-live">Check offer is live</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Check whether an offer is ‘live’, that is: inserted in the order book. The Mangrove holds a <code>outbound_tkn =&gt; inbound_tkn =&gt; id =&gt; bytes32</code> mapping in storage. Offer ids that are not yet assigned or that point to since-deleted offer will point to an offer with <code>gives</code> field at 0.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>139
140
141
142</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">isLive</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> offer<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> $$<span class="token punctuation">(</span><span class="token function">offer_gives</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mgvoffermaking.sol" class="left filebreak">MgvOfferMaking.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7</pre></code>
          <pre>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.7.0</span><span class="token punctuation">;</span>
<span class="token keyword">pragma</span> abicoder v2<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>IMaker<span class="token punctuation">,</span> HasMgvEvents<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvHasOffers<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvHasOffers.sol"</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>MgvOfferMaking</code> contains market-making-related functions.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>9</pre></code>
          <pre><span class="token keyword">contract</span> <span class="token class-name">MgvOfferMaking</span> <span class="token keyword">is</span> MgvHasOffers <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffermaking.sol-public-maker-operations">Public Maker operations</h1>
<h2 id="mgvoffermaking.sol-new-offer">New Offer</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In the Mangrove, makers and takers call separate functions. Market makers call <code>newOffer</code> to fill the book, and takers call functions such as <code>marketOrder</code> to consume it.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The following structs holds offer creation/update parameters in memory. This frees up stack space for local variables.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>18
19
20
21
22
23
24
25
26
27
28</pre></code>
          <pre>  <span class="token keyword">struct</span> <span class="token class-name">OfferPack</span> <span class="token punctuation">{</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">;</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> wants<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> gives<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> id<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> gasreq<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> gasprice<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> pivotId<span class="token punctuation">;</span>
    <span class="token builtin">bytes32</span> global<span class="token punctuation">;</span>
    <span class="token builtin">bytes32</span> local<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>used on update only</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>30
31
32</pre></code>
          <pre>    <span class="token builtin">bytes32</span> oldOffer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The function <code>newOffer</code> is for market makers only; no match with the existing book is done. A maker specifies how much <code>inbound_tkn</code> it <code>wants</code> and how much <code>outbound_tkn</code> it <code>gives</code>.</p>
<p>It also specify with <code>gasreq</code> how much gas should be given when executing their offer.</p>
<p><code>gasprice</code> indicates an upper bound on the gasprice at which the maker is ready to be penalised if their offer fails. Any value below the Mangrove’s internal <code>gasprice</code> configuration value will be ignored.</p>
<p><code>gasreq</code>, together with <code>gasprice</code>, will contribute to determining the penalty provision set aside by the Mangrove from the market maker’s <code>balanceOf</code> balance.</p>
<p>Offers are always inserted at the correct place in the book. This requires walking through offers to find the correct insertion point. As in <a href="https://github.com/daifoundation/maker-otc/blob/f2060c5fe12fe3da71ac98e8f6acc06bca3698f5/src/matching_market.sol#L493">Oasis</a>, the maker should find the id of an offer close to its own and provide it as <code>pivotId</code>.</p>
<p>An offer cannot be inserted in a closed market, nor when a reentrancy lock for <code>outbound_tkn</code>,<code>inbound_tkn</code> is on.</p>
<p>No more than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>24</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{24}-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> offers can ever be created for one <code>outbound_tkn</code>,<code>inbound_tkn</code> pair.</p>
<p>The actual contents of the function is in <code>writeOffer</code>, which is called by both <code>newOffer</code> and <code>updateOffer</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>49
50
51
52
53
54
55
56
57</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">newOffer</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> wants<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gives<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasreq<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> pivotId
  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In preparation for calling <code>writeOffer</code>, we read the <code>outbound_tkn</code>,<code>inbound_tkn</code> pair configuration, check for reentrancy and market liveness, fill the <code>OfferPack</code> struct and increment the <code>outbound_tkn</code>,<code>inbound_tkn</code> pair’s <code>last</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76</pre></code>
          <pre>    OfferPack <span class="token keyword">memory</span> ofp<span class="token punctuation">;</span>
    <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>global<span class="token punctuation">,</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unlockedMarketOnly</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">activeMarketOnly</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>global<span class="token punctuation">,</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ofp<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> $$<span class="token punctuation">(</span><span class="token function">local_last</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint24</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token operator">==</span> ofp<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">"mgv/offerIdOverflow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ofp<span class="token punctuation">.</span>local <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"last"</span><span class="token punctuation">,</span> <span class="token string">"ofp.id"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ofp<span class="token punctuation">.</span>outbound_tkn <span class="token operator">=</span> outbound_tkn<span class="token punctuation">;</span>
    ofp<span class="token punctuation">.</span>inbound_tkn <span class="token operator">=</span> inbound_tkn<span class="token punctuation">;</span>
    ofp<span class="token punctuation">.</span>wants <span class="token operator">=</span> wants<span class="token punctuation">;</span>
    ofp<span class="token punctuation">.</span>gives <span class="token operator">=</span> gives<span class="token punctuation">;</span>
    ofp<span class="token punctuation">.</span>gasreq <span class="token operator">=</span> gasreq<span class="token punctuation">;</span>
    ofp<span class="token punctuation">.</span>gasprice <span class="token operator">=</span> gasprice<span class="token punctuation">;</span>
    ofp<span class="token punctuation">.</span>pivotId <span class="token operator">=</span> pivotId<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The second parameter to writeOffer indicates that we are creating a new offer, not updating an existing one.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>78
79</pre></code>
          <pre>    <span class="token function">writeOffer</span><span class="token punctuation">(</span>ofp<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Since we locally modified a field of the local configuration (<code>last</code>), we save the change to storage. Note that <code>writeOffer</code> may have further modified the local configuration by updating the current <code>best</code> offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>81
82
83
84</pre></code>
          <pre>    locals<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">]</span> <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">;</span>
    <span class="token keyword">return</span> ofp<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffermaking.sol-update-offer">Update Offer</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Very similar to <code>newOffer</code>, <code>updateOffer</code> prepares an <code>OfferPack</code> for <code>writeOffer</code>. Makers should use it for updating live offers, but also to save on gas by reusing old, already consumed offers.</p>
<p>A <code>pivotId</code> should still be given to minimise reads in the offer book. It is OK to give the offers’ own id as a pivot.</p>
<p>Gas use is minimal when:</p>
<ol>
<li>The offer does not move in the book</li>
<li>The offer does not change its <code>gasreq</code></li>
<li>The (<code>outbound_tkn</code>,<code>inbound_tkn</code>)'s <code>*_gasbase</code> has not changed since the offer was last written</li>
<li><code>gasprice</code> has not changed since the offer was last written</li>
<li><code>gasprice</code> is greater than the Mangrove’s gasprice estimation</li>
</ol>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">updateOffer</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> wants<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gives<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasreq<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> pivotId<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> offerId
  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">{</span>
    OfferPack <span class="token keyword">memory</span> ofp<span class="token punctuation">;</span>
    <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>global<span class="token punctuation">,</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unlockedMarketOnly</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">activeMarketOnly</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>global<span class="token punctuation">,</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ofp<span class="token punctuation">.</span>outbound_tkn <span class="token operator">=</span> outbound_tkn<span class="token punctuation">;</span>
    ofp<span class="token punctuation">.</span>inbound_tkn <span class="token operator">=</span> inbound_tkn<span class="token punctuation">;</span>
    ofp<span class="token punctuation">.</span>wants <span class="token operator">=</span> wants<span class="token punctuation">;</span>
    ofp<span class="token punctuation">.</span>gives <span class="token operator">=</span> gives<span class="token punctuation">;</span>
    ofp<span class="token punctuation">.</span>id <span class="token operator">=</span> offerId<span class="token punctuation">;</span>
    ofp<span class="token punctuation">.</span>gasreq <span class="token operator">=</span> gasreq<span class="token punctuation">;</span>
    ofp<span class="token punctuation">.</span>gasprice <span class="token operator">=</span> gasprice<span class="token punctuation">;</span>
    ofp<span class="token punctuation">.</span>pivotId <span class="token operator">=</span> pivotId<span class="token punctuation">;</span>
    ofp<span class="token punctuation">.</span>oldOffer <span class="token operator">=</span> offers<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>Save local config</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>123</pre></code>
          <pre>    <span class="token builtin">bytes32</span> oldLocal <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The second argument indicates that we are updating an existing offer, not creating a new one.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>125</pre></code>
          <pre>    <span class="token function">writeOffer</span><span class="token punctuation">(</span>ofp<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We saved the current pair’s configuration before calling <code>writeOffer</code>, since that function may update the current <code>best</code> offer. We now check for any change to the configuration and update it if needed.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>127
128
129
130
131</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldLocal <span class="token operator">!=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      locals<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">]</span> <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffermaking.sol-retract-offer">Retract Offer</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>retractOffer</code> takes the offer <code>offerId</code> out of the book. However, <code>deprovision == true</code> also refunds the provision associated with the offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>135
136
137
138
139
140
141
142
143
144
145
146
147
148
149</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">retractOffer</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> offerId<span class="token punctuation">,</span>
    <span class="token builtin">bool</span> deprovision
  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span> local<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unlockedMarketOnly</span><span class="token punctuation">(</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">bytes32</span> offer <span class="token operator">=</span> offers<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token builtin">bytes32</span> offerDetail <span class="token operator">=</span> offerDetails<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>
      msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_maker</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">"mgv/retractOffer/unauthorized"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Here, we are about to un-live an offer, so we start by taking it out of the book by stitching together its previous and next offers. Note that unconditionally calling <code>stitchOffers</code> would break the book since it would connect offers that may have since moved.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>151
152
153
154
155
156
157
158
159</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLive</span><span class="token punctuation">(</span>offer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">bytes32</span> oldLocal <span class="token operator">=</span> local<span class="token punctuation">;</span>
      local <span class="token operator">=</span> <span class="token function">stitchOffers</span><span class="token punctuation">(</span>
        outbound_tkn<span class="token punctuation">,</span>
        inbound_tkn<span class="token punctuation">,</span>
        $$<span class="token punctuation">(</span><span class="token function">offer_prev</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        $$<span class="token punctuation">(</span><span class="token function">offer_next</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        local
      <span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If calling <code>stitchOffers</code> has changed the current <code>best</code> offer, we update the storage.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>161
162
163
164</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldLocal <span class="token operator">!=</span> local<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        locals<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span> <span class="token operator">=</span> local<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Set <code>gives</code> to 0. Moreover, the last argument depends on whether the user wishes to get their provision back (if true, <code>gasprice</code> will be set to 0 as well).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>166
167</pre></code>
          <pre>    <span class="token function">dirtyDeleteOffer</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> offerId<span class="token punctuation">,</span> offer<span class="token punctuation">,</span> deprovision<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the user wants to get their provision back, we compute its provision from the offer’s <code>gasprice</code>, <code>*_gasbase</code> and <code>gasreq</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>169
170
171
172
173
174</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>deprovision<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> provision <span class="token operator">=</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">9</span> <span class="token operator">*</span>
        $$<span class="token punctuation">(</span><span class="token function">offer_gasprice</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token comment">//gasprice is 0 if offer was deprovisioned</span>
        <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
          $$<span class="token punctuation">(</span><span class="token function">offerDetail_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
          $$<span class="token punctuation">(</span><span class="token function">offerDetail_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>credit <code>balanceOf</code> and log transfer</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>176
177
178
179
180</pre></code>
          <pre>      <span class="token function">creditWei</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> provision<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">emit</span> <span class="token function">OfferRetract</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> offerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffermaking.sol-provisioning">Provisioning</h2>
<p>Market makers must have enough provisions for possible penalties. These provisions are in ETH. Every time a new offer is created or an offer is updated, <code>balanceOf</code> is adjusted to provision the offer’s maximum possible penalty (<code>gasprice * (gasreq + overhead_gasbase + offer_gasbase)</code>).</p>
<p>For instance, if the current <code>balanceOf</code> of a maker is 1 ether and they create an offer that requires a provision of 0.01 ethers, their <code>balanceOf</code> will be reduced to 0.99 ethers. No ethers will move; this is just an internal accounting movement to make sure the maker cannot <code>withdraw</code> the provisioned amounts.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Fund should be called with a nonzero value (hence the <code>payable</code> modifier). The provision will be given to <code>maker</code>, not <code>msg.sender</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>190
191
192
193
194
195
196
197
198
199</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">fund</span><span class="token punctuation">(</span><span class="token builtin">address</span> maker<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token builtin">bytes32</span> _global<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">liveMgvOnly</span><span class="token punctuation">(</span>_global<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">creditWei</span><span class="token punctuation">(</span>maker<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">fund</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span>
    <span class="token function">fund</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>A transfer with enough gas to the Mangrove will increase the caller’s available <code>balanceOf</code> balance. <em>You should send enough gas to execute this function when sending money to the Mangrove.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>201
202
203
204</pre></code>
          <pre>  <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span>
    <span class="token function">fund</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Any provision not currently held to secure an offer’s possible penalty is available for withdrawal.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>206</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span> noRevert<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Since we only ever send money to the caller, we do not need to provide any particular amount of gas, the caller should manage this herself.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>208
209
210
211</pre></code>
          <pre>    <span class="token function">debitWei</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span>noRevert<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span>call<span class="token punctuation">{</span>value<span class="token punctuation">:</span> amount<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffermaking.sol-low-level-maker-functions">Low-level Maker functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffermaking.sol-write-offer">Write Offer</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>215
216</pre></code>
          <pre>
  <span class="token keyword">function</span> <span class="token function">writeOffer</span><span class="token punctuation">(</span>OfferPack <span class="token keyword">memory</span> ofp<span class="token punctuation">,</span> <span class="token builtin">bool</span> update<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>gasprice</code>’s floor is Mangrove’s own gasprice estimate, <code>ofp.global.gasprice</code>. We first check that gasprice fits in 16 bits. Otherwise it could be that <code>uint16(gasprice) &lt; global_gasprice &lt; gasprice</code>, and the actual value we store is <code>uint16(gasprice)</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>218
219
220
221
222
223
224
225
226</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>
      <span class="token builtin">uint16</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gasprice<span class="token punctuation">)</span> <span class="token operator">==</span> ofp<span class="token punctuation">.</span>gasprice<span class="token punctuation">,</span>
      <span class="token string">"mgv/writeOffer/gasprice/16bits"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gasprice <span class="token operator">&lt;</span> $$<span class="token punctuation">(</span><span class="token function">global_gasprice</span><span class="token punctuation">(</span><span class="token string">"ofp.global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ofp<span class="token punctuation">.</span>gasprice <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">global_gasprice</span><span class="token punctuation">(</span><span class="token string">"ofp.global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Check <code>gasreq</code> below limit. Implies <code>gasreq</code> at most 24 bits wide, which ensures no overflow in computation of <code>provision</code> (see below).</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>228
229
230
231</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>
      ofp<span class="token punctuation">.</span>gasreq <span class="token operator">&lt;=</span> $$<span class="token punctuation">(</span><span class="token function">global_gasmax</span><span class="token punctuation">(</span><span class="token string">"ofp.global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">"mgv/writeOffer/gasreq/tooHigh"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Make sure <code>gives &gt; 0</code> – division by 0 would throw in several places otherwise, and <code>isLive</code> relies on it.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>233</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gives <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"mgv/writeOffer/gives/tooLow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Make sure that the maker is posting a ‘dense enough’ offer: the ratio of <code>outbound_tkn</code> offered per gas consumed must be high enough. The actual gas cost paid by the taker is overapproximated by adding <code>offer_gasbase</code> to <code>gasreq</code>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>235
236
237
238
239
240
241</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>
      ofp<span class="token punctuation">.</span>gives <span class="token operator">>=</span>
        <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gasreq <span class="token operator">+</span> $$<span class="token punctuation">(</span><span class="token function">local_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span>
          $$<span class="token punctuation">(</span><span class="token function">local_density</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">"mgv/writeOffer/density/tooLow"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The following checks are for the maker’s convenience only.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>243
244
245</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint96</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gives<span class="token punctuation">)</span> <span class="token operator">==</span> ofp<span class="token punctuation">.</span>gives<span class="token punctuation">,</span> <span class="token string">"mgv/writeOffer/gives/96bits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint96</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>wants<span class="token punctuation">)</span> <span class="token operator">==</span> ofp<span class="token punctuation">.</span>wants<span class="token punctuation">,</span> <span class="token string">"mgv/writeOffer/wants/96bits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The position of the new or updated offer is found using <code>findPosition</code>. If the offer is the best one, <code>prev == 0</code>, and if it’s the last in the book, <code>next == 0</code>.</p>
<p><code>findPosition</code> is only ever called here, but exists as a separate function to make the code easier to read.</p>
<p><strong>Warning</strong>: <code>findPosition</code> will call <code>better</code>, which may read the offer’s <code>offerDetails</code>. So it is important to find the offer position <em>before</em> we update its <code>offerDetail</code> in storage. We waste 1 (hot) read in that case but we deem that the code would get too ugly if we passed the old <code>offerDetail</code> as argument to <code>findPosition</code> and to <code>better</code>, just to save 1 hot read in that specific case.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>251
252</pre></code>
          <pre>    <span class="token punctuation">(</span><span class="token builtin">uint</span> prev<span class="token punctuation">,</span> <span class="token builtin">uint</span> next<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">findPosition</span><span class="token punctuation">(</span>ofp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Log the write offer event.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>254
255
256
257
258
259
260
261
262
263
264
265</pre></code>
          <pre>    <span class="token keyword">emit</span> <span class="token function">OfferWrite</span><span class="token punctuation">(</span>
      ofp<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span>
      ofp<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span>
      msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>
      ofp<span class="token punctuation">.</span>wants<span class="token punctuation">,</span>
      ofp<span class="token punctuation">.</span>gives<span class="token punctuation">,</span>
      ofp<span class="token punctuation">.</span>gasprice<span class="token punctuation">,</span>
      ofp<span class="token punctuation">.</span>gasreq<span class="token punctuation">,</span>
      ofp<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      prev
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We now write the new <code>offerDetails</code> and remember the previous provision (0 by default, for new offers) to balance out maker’s <code>balanceOf</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284</pre></code>
          <pre>    <span class="token builtin">uint</span> oldProvision<span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
      <span class="token builtin">bytes32</span> offerDetail <span class="token operator">=</span> offerDetails<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>
        ofp<span class="token punctuation">.</span>id
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>
          msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_maker</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string">"mgv/updateOffer/unauthorized"</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        oldProvision <span class="token operator">=</span>
          <span class="token number">10</span><span class="token operator">**</span><span class="token number">9</span> <span class="token operator">*</span>
          $$<span class="token punctuation">(</span><span class="token function">offer_gasprice</span><span class="token punctuation">(</span><span class="token string">"ofp.oldOffer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span>
          <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            $$<span class="token punctuation">(</span><span class="token function">offerDetail_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            $$<span class="token punctuation">(</span><span class="token function">offerDetail_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the offer is new, has a new <code>gasreq</code>, or if the Mangrove’s <code>*_gasbase</code> configuration parameter has changed, we also update <code>offerDetails</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token operator">!</span>update <span class="token operator">||</span>
        $$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> ofp<span class="token punctuation">.</span>gasreq <span class="token operator">||</span>
        $$<span class="token punctuation">(</span><span class="token function">offerDetail_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
        $$<span class="token punctuation">(</span><span class="token function">local_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        $$<span class="token punctuation">(</span><span class="token function">offerDetail_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
        $$<span class="token punctuation">(</span><span class="token function">local_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint</span> overhead_gasbase <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">local_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint</span> offer_gasbase <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">local_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        offerDetails<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span>
          <span class="token function">make_offerDetail</span><span class="token punctuation">(</span>
            <span class="token punctuation">[</span>
              <span class="token punctuation">[</span><span class="token string">"maker"</span><span class="token punctuation">,</span> <span class="token string">"uint(msg.sender)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">[</span><span class="token string">"gasreq"</span><span class="token punctuation">,</span> <span class="token string">"ofp.gasreq"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">[</span><span class="token string">"overhead_gasbase"</span><span class="token punctuation">,</span> <span class="token string">"overhead_gasbase"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">[</span><span class="token string">"offer_gasbase"</span><span class="token punctuation">,</span> <span class="token string">"offer_gasbase"</span><span class="token punctuation">]</span>
            <span class="token punctuation">]</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>With every change to an offer, a maker may deduct provisions from its <code>balanceOf</code> balance. It may also get provisions back if the updated offer requires fewer provisions than before.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>310
311
312
313
314
315
316
317
318
319
320
321</pre></code>
          <pre>    <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> provision <span class="token operator">=</span> <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gasreq <span class="token operator">+</span>
        $$<span class="token punctuation">(</span><span class="token function">local_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
        $$<span class="token punctuation">(</span><span class="token function">local_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span>
        ofp<span class="token punctuation">.</span>gasprice <span class="token operator">*</span>
        <span class="token number">10</span><span class="token operator">**</span><span class="token number">9</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>provision <span class="token operator">></span> oldProvision<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">debitWei</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> provision <span class="token operator">-</span> oldProvision<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>provision <span class="token operator">&lt;</span> oldProvision<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">creditWei</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> oldProvision <span class="token operator">-</span> provision<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We now place the offer in the book at the position found by <code>findPosition</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>First, we test if the offer has moved in the book or is not currently in the book. If <code>!isLive(ofp.oldOffer)</code>, we must update its prev/next. If it is live but its prev has changed, we must also update them. Note that checking both <code>prev = oldPrev</code> and <code>next == oldNext</code> would be redundant. If either is true, then the updated offer has not changed position and there is nothing to update.</p>
<p>As a note for future changes, there is a tricky edge case where <code>prev == oldPrev</code> yet the prev/next should be changed: a previously-used offer being brought back in the book, and ending with the same prev it had when it was in the book. In that case, the neighbor is currently pointing to <em>another</em> offer, and thus must be updated. With the current code structure, this is taken care of as a side-effect of checking <code>!isLive</code>, but should be kept in mind. The same goes in the <code>next == oldNext</code> case.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>327</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isLive</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>oldOffer<span class="token punctuation">)</span> <span class="token operator">||</span> prev <span class="token operator">!=</span> $$<span class="token punctuation">(</span><span class="token function">offer_prev</span><span class="token punctuation">(</span><span class="token string">"ofp.oldOffer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>If the offer is not the best one, we update its predecessor; otherwise we update the <code>best</code> value.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>329
330
331
332
333
334
335
336
337
338
339</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        offers<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>prev<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span>
          <span class="token function">set_offer</span><span class="token punctuation">(</span>
            <span class="token string">"offers[ofp.outbound_tkn][ofp.inbound_tkn][prev]"</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"next"</span><span class="token punctuation">,</span> <span class="token string">"ofp.id"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ofp<span class="token punctuation">.</span>local <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"best"</span><span class="token punctuation">,</span> <span class="token string">"ofp.id"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>If the offer is not the last one, we update its successor.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>341
342
343
344
345
346
347
348
349</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        offers<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>next<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span>
          <span class="token function">set_offer</span><span class="token punctuation">(</span>
            <span class="token string">"offers[ofp.outbound_tkn][ofp.inbound_tkn][next]"</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"prev"</span><span class="token punctuation">,</span> <span class="token string">"ofp.id"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Recall that in this branch, the offer has changed location, or is not currently in the book. If the offer is not new and already in the book, we must remove it from its previous location by stitching its previous prev/next.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>351
352
353
354
355
356
357
358
359
360
361</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>update <span class="token operator">&amp;&amp;</span> <span class="token function">isLive</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>oldOffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ofp<span class="token punctuation">.</span>local <span class="token operator">=</span> <span class="token function">stitchOffers</span><span class="token punctuation">(</span>
          ofp<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span>
          ofp<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span>
          $$<span class="token punctuation">(</span><span class="token function">offer_prev</span><span class="token punctuation">(</span><span class="token string">"ofp.oldOffer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          $$<span class="token punctuation">(</span><span class="token function">offer_next</span><span class="token punctuation">(</span><span class="token string">"ofp.oldOffer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          ofp<span class="token punctuation">.</span>local
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>With the <code>prev</code>/<code>next</code> in hand, we finally store the offer in the <code>offers</code> map.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>363
364
365
366
367
368
369
370
371
372
373
374
375
376</pre></code>
          <pre>    <span class="token builtin">bytes32</span> ofr <span class="token operator">=</span> $$<span class="token punctuation">(</span>
      <span class="token function">make_offer</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>
          <span class="token punctuation">[</span><span class="token string">"prev"</span><span class="token punctuation">,</span> <span class="token string">"prev"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token string">"next"</span><span class="token punctuation">,</span> <span class="token string">"next"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token string">"wants"</span><span class="token punctuation">,</span> <span class="token string">"ofp.wants"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token string">"gives"</span><span class="token punctuation">,</span> <span class="token string">"ofp.gives"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token string">"gasprice"</span><span class="token punctuation">,</span> <span class="token string">"ofp.gasprice"</span><span class="token punctuation">]</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    offers<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> ofr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffermaking.sol-find-position">Find Position</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>findPosition</code> takes a price in the form of a (<code>ofp.wants</code>,<code>ofp.gives</code>) pair, an offer id (<code>ofp.pivotId</code>) and walks the book from that offer (backward or forward) until the right position for the price is found. The position is returned as a <code>(prev,next)</code> pair, with <code>prev</code> or <code>next</code> at 0 to mark the beginning/end of the book (no offer ever has id 0).</p>
<p>If prices are equal, <code>findPosition</code> will put the newest offer last.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>381
382
383
384
385
386
387
388</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">findPosition</span><span class="token punctuation">(</span>OfferPack <span class="token keyword">memory</span> ofp<span class="token punctuation">)</span>
    <span class="token keyword">internal</span>
    <span class="token keyword">view</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">,</span> <span class="token builtin">uint</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token builtin">uint</span> prevId<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> nextId<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> pivotId <span class="token operator">=</span> ofp<span class="token punctuation">.</span>pivotId<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Get <code>pivot</code>, optimizing for the case where pivot info is already known</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>390
391
392
393</pre></code>
          <pre>    <span class="token builtin">bytes32</span> pivot <span class="token operator">=</span> pivotId <span class="token operator">==</span> ofp<span class="token punctuation">.</span>id
      <span class="token operator">?</span> ofp<span class="token punctuation">.</span>oldOffer
      <span class="token punctuation">:</span> offers<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>pivotId<span class="token punctuation">]</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In case pivotId is not an active offer, it is unusable (since it is out of the book). We default to the current best offer. If the book is empty pivot will be 0. That is handled through a test in the <code>better</code> comparison function.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>395
396
397
398
399</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isLive</span><span class="token punctuation">(</span>pivot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pivotId <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">local_best</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      pivot <span class="token operator">=</span> offers<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>pivotId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Pivot is better than <code>wants/gives</code>, we follow <code>next</code>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>401
402
403
404
405
406
407
408
409
410
411
412</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">better</span><span class="token punctuation">(</span>ofp<span class="token punctuation">,</span> pivot<span class="token punctuation">,</span> pivotId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">bytes32</span> pivotNext<span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">offer_next</span><span class="token punctuation">(</span><span class="token string">"pivot"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint</span> pivotNextId <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offer_next</span><span class="token punctuation">(</span><span class="token string">"pivot"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pivotNext <span class="token operator">=</span> offers<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>pivotNextId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">better</span><span class="token punctuation">(</span>ofp<span class="token punctuation">,</span> pivotNext<span class="token punctuation">,</span> pivotNextId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          pivotId <span class="token operator">=</span> pivotNextId<span class="token punctuation">;</span>
          pivot <span class="token operator">=</span> pivotNext<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>gets here on empty book</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>414
415</pre></code>
          <pre>      <span class="token punctuation">(</span>prevId<span class="token punctuation">,</span> nextId<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>pivotId<span class="token punctuation">,</span> $$<span class="token punctuation">(</span><span class="token function">offer_next</span><span class="token punctuation">(</span><span class="token string">"pivot"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Pivot is strictly worse than <code>wants/gives</code>, we follow <code>prev</code>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438</pre></code>
          <pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token builtin">bytes32</span> pivotPrev<span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">offer_prev</span><span class="token punctuation">(</span><span class="token string">"pivot"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint</span> pivotPrevId <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offer_prev</span><span class="token punctuation">(</span><span class="token string">"pivot"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pivotPrev <span class="token operator">=</span> offers<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>pivotPrevId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">better</span><span class="token punctuation">(</span>ofp<span class="token punctuation">,</span> pivotPrev<span class="token punctuation">,</span> pivotPrevId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          pivotId <span class="token operator">=</span> pivotPrevId<span class="token punctuation">;</span>
          pivot <span class="token operator">=</span> pivotPrev<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token punctuation">(</span>prevId<span class="token punctuation">,</span> nextId<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">offer_prev</span><span class="token punctuation">(</span><span class="token string">"pivot"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pivotId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      prevId <span class="token operator">==</span> ofp<span class="token punctuation">.</span>id <span class="token operator">?</span> $$<span class="token punctuation">(</span><span class="token function">offer_prev</span><span class="token punctuation">(</span><span class="token string">"ofp.oldOffer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> prevId<span class="token punctuation">,</span>
      nextId <span class="token operator">==</span> ofp<span class="token punctuation">.</span>id <span class="token operator">?</span> $$<span class="token punctuation">(</span><span class="token function">offer_next</span><span class="token punctuation">(</span><span class="token string">"ofp.oldOffer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> nextId
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffermaking.sol-better">Better</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The utility method <code>better</code> takes an offer represented by <code>ofp</code> and another represented by <code>offer1</code>. It returns true iff <code>offer1</code> is better or as good as <code>ofp</code>.
“better” is defined on the lexicographic order <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>price</mtext><msub><mo>×</mo><mtext>lex</mtext></msub><msup><mtext>density</mtext><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\textrm{price} \times_{\textrm{lex}} \textrm{density}^{-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8623000000000001em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">price</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin"><span class="mbin">×</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord textrm mtight">lex</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.0928879999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord text"><span class="mord textrm">density</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.14734em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span>. This means that for the same price, offers that deliver more volume per gas are taken first.</p>
<p>In addition to <code>offer1</code>, we also provide its id, <code>offerId1</code> in order to save gas. If necessary (ie. if the prices <code>wants1/gives1</code> and <code>wants2/gives2</code> are the same), we read storage to get <code>gasreq1</code> at `offerDetails[…][offerId1].</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>444
445
446
447
448
449</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">better</span><span class="token punctuation">(</span>
    OfferPack <span class="token keyword">memory</span> ofp<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> offer1<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> offerId1
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>offerId1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Happens on empty book. Returning <code>false</code> would work as well due to specifics of <code>findPosition</code> but true is more consistent. Here we just want to avoid reading <code>offerDetail[...][0]</code> for nothing.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471</pre></code>
          <pre>      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token builtin">uint</span> wants1 <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offer_wants</span><span class="token punctuation">(</span><span class="token string">"offer1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">uint</span> gives1 <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offer_gives</span><span class="token punctuation">(</span><span class="token string">"offer1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">uint</span> wants2 <span class="token operator">=</span> ofp<span class="token punctuation">.</span>wants<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> gives2 <span class="token operator">=</span> ofp<span class="token punctuation">.</span>gives<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> weight1 <span class="token operator">=</span> wants1 <span class="token operator">*</span> gives2<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> weight2 <span class="token operator">=</span> wants2 <span class="token operator">*</span> gives1<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>weight1 <span class="token operator">==</span> weight2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> gasreq1 <span class="token operator">=</span> $$<span class="token punctuation">(</span>
        <span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span>
          <span class="token string">"offerDetails[ofp.outbound_tkn][ofp.inbound_tkn][offerId1]"</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">uint</span> gasreq2 <span class="token operator">=</span> ofp<span class="token punctuation">.</span>gasreq<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>gives1 <span class="token operator">*</span> gasreq2 <span class="token operator">>=</span> gives2 <span class="token operator">*</span> gasreq1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> weight1 <span class="token operator">&lt;</span> weight2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mgvoffertaking.sol" class="left filebreak">MgvOfferTaking.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7
8</pre></code>
          <pre>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.7.0</span><span class="token punctuation">;</span>
<span class="token keyword">pragma</span> abicoder v2<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>IERC20<span class="token punctuation">,</span> HasMgvEvents<span class="token punctuation">,</span> IMaker<span class="token punctuation">,</span> IMgvMonitor<span class="token punctuation">,</span> MgvLib <span class="token keyword">as</span> ML<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvHasOffers<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvHasOffers.sol"</span><span class="token punctuation">;</span>

abstract <span class="token keyword">contract</span> <span class="token class-name">MgvOfferTaking</span> <span class="token keyword">is</span> MgvHasOffers <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertaking.sol-multiorder-struct">MultiOrder struct</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The <code>MultiOrder</code> struct is used by market orders and snipes. Some of its fields are only used by market orders (<code>initialWants, initialGives</code>, <code>fillWants</code>), and others only by snipes (<code>successCount</code>). We need a common data structure for both since low-level calls are shared between market orders and snipes. The struct is helpful in decreasing stack use.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>11
12
13
14
15
16
17
18
19
20
21
22</pre></code>
          <pre>  <span class="token keyword">struct</span> <span class="token class-name">MultiOrder</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint</span> initialWants<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> initialGives<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> totalGot<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> totalGave<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> totalPenalty<span class="token punctuation">;</span>
    <span class="token builtin">address</span> taker<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> successCount<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> failCount<span class="token punctuation">;</span>
    <span class="token builtin">bool</span> fillWants<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertaking.sol-market-orders">Market Orders</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-market-order">Market Order</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>A market order specifies a (<code>outbound_tkn</code>,<code>inbound_tkn</code>) pair, a desired total amount of <code>outbound_tkn</code> (<code>takerWants</code>), and an available total amount of <code>inbound_tkn</code> (<code>takerGives</code>). It returns two <code>uint</code>s: the total amount of <code>outbound_tkn</code> received and the total amount of <code>inbound_tkn</code> spent.</p>
<p>The <code>takerGives/takerWants</code> ratio induces a maximum average price that the taker is ready to pay across all offers that will be executed during the market order. It is thus possible to execute an offer with a price worse than the initial (<code>takerGives</code>/<code>takerWants</code>) ratio given as argument to <code>marketOrder</code> if some cheaper offers were executed earlier in the market order.</p>
<p>The market order stops when the price has become too high, or when the end of the book has been reached, or:</p>
<ul>
<li>If <code>fillWants</code> is true, the market order stops when <code>takerWants</code> units of <code>outbound_tkn</code> have been obtained. With <code>fillWants</code> set to true, to buy a specific volume of <code>outbound_tkn</code> at any price, set <code>takerWants</code> to the amount desired and <code>takerGives</code> to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>160</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{160}-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">6</span><span class="mord mtight">0</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>.</li>
<li>If <code>fillWants</code> is false, the taker is filling <code>gives</code> instead: the market order stops when <code>takerGives</code> units of <code>inbound_tkn</code> have been sold. With <code>fillWants</code> set to false, to sell a specific volume of <code>inbound_tkn</code> at any price, set <code>takerGives</code> to the amount desired and <code>takerWants</code> to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">marketOrder</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerGives<span class="token punctuation">,</span>
    <span class="token builtin">bool</span> fillWants
  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">,</span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
      <span class="token function">generalMarketOrder</span><span class="token punctuation">(</span>
        outbound_tkn<span class="token punctuation">,</span>
        inbound_tkn<span class="token punctuation">,</span>
        takerWants<span class="token punctuation">,</span>
        takerGives<span class="token punctuation">,</span>
        fillWants<span class="token punctuation">,</span>
        msg<span class="token punctuation">.</span>sender
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertaking.sol-general-market-order">General Market Order</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>General market orders set up the market order with a given <code>taker</code> (<code>msg.sender</code> in the most common case). Returns <code>(totalGot, totalGave)</code>.
Note that the <code>taker</code> can be anyone. This is safe when <code>taker == msg.sender</code>, but <code>generalMarketOrder</code> must not be called with <code>taker != msg.sender</code> unless a security check is done after (see <a href="#mgvoffertakingwithpermit.sol"><code>MgvOfferTakingWithPermit</code></a>`.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>57
58
59
60
61
62
63
64</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">generalMarketOrder</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerGives<span class="token punctuation">,</span>
    <span class="token builtin">bool</span> fillWants<span class="token punctuation">,</span>
    <span class="token builtin">address</span> taker
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">,</span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Since amounts stored in offers are 96 bits wide, checking that <code>takerWants</code> and <code>takerGives</code> fit in 160 bits prevents overflow during the main market order loop.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>66
67
68</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint160</span><span class="token punctuation">(</span>takerWants<span class="token punctuation">)</span> <span class="token operator">==</span> takerWants<span class="token punctuation">,</span> <span class="token string">"mgv/mOrder/takerWants/160bits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint160</span><span class="token punctuation">(</span>takerGives<span class="token punctuation">)</span> <span class="token operator">==</span> takerGives<span class="token punctuation">,</span> <span class="token string">"mgv/mOrder/takerGives/160bits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>SingleOrder</code> is defined in <code>MgvLib.sol</code> and holds information for ordering the execution of one offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>70
71
72
73</pre></code>
          <pre>    ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">;</span>
    sor<span class="token punctuation">.</span>outbound_tkn <span class="token operator">=</span> outbound_tkn<span class="token punctuation">;</span>
    sor<span class="token punctuation">.</span>inbound_tkn <span class="token operator">=</span> inbound_tkn<span class="token punctuation">;</span>
    <span class="token punctuation">(</span>sor<span class="token punctuation">.</span>global<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Throughout the execution of the market order, the <code>sor</code>’s offer id and other parameters will change. We start with the current best offer id (0 if the book is empty).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>75
76</pre></code>
          <pre>    sor<span class="token punctuation">.</span>offerId <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">local_best</span><span class="token punctuation">(</span><span class="token string">"sor.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sor<span class="token punctuation">.</span>offer <span class="token operator">=</span> offers<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>sor.wants</code> and <code>sor.gives</code> may evolve, but they are initially however much remains in the market order.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>78
79
80</pre></code>
          <pre>    sor<span class="token punctuation">.</span>wants <span class="token operator">=</span> takerWants<span class="token punctuation">;</span>
    sor<span class="token punctuation">.</span>gives <span class="token operator">=</span> takerGives<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>MultiOrder</code> (defined above) maintains information related to the entire market order. During the order, initial <code>wants</code>/<code>gives</code> values minus the accumulated amounts traded so far give the amounts that remain to be traded.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>82
83
84
85
86
87</pre></code>
          <pre>    MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">;</span>
    mor<span class="token punctuation">.</span>initialWants <span class="token operator">=</span> takerWants<span class="token punctuation">;</span>
    mor<span class="token punctuation">.</span>initialGives <span class="token operator">=</span> takerGives<span class="token punctuation">;</span>
    mor<span class="token punctuation">.</span>taker <span class="token operator">=</span> taker<span class="token punctuation">;</span>
    mor<span class="token punctuation">.</span>fillWants <span class="token operator">=</span> fillWants<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>For the market order to even start, the market needs to be both active, and not currently protected from reentrancy.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>89
90
91</pre></code>
          <pre>    <span class="token function">activeMarketOnly</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>global<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unlockedMarketOnly</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Initialization</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The market order will operate as follows : it will go through offers from best to worse, starting from <code>offerId</code>, and:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>will maintain remaining <code>takerWants</code> and <code>takerGives</code> values. The initial <code>takerGives/takerWants</code> ratio is the average price the taker will accept. Better prices may be found early in the book, and worse ones later.</li>
<li>will not set <code>prev</code>/<code>next</code> pointers to their correct locations at each offer taken (this is an optimization enabled by forbidding reentrancy).</li>
<li>after consuming a segment of offers, will update the current <code>best</code> offer to be the best remaining offer on the book.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We start be enabling the reentrancy lock for this (<code>outbound_tkn</code>,<code>inbound_tkn</code>) pair.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>99
100
101</pre></code>
          <pre>    sor<span class="token punctuation">.</span>local <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"sor.local"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"lock"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    locals<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span> <span class="token operator">=</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Call recursive <code>internalMarketOrder</code> function.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>103
104</pre></code>
          <pre>    <span class="token function">internalMarketOrder</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Over the course of the market order, a penalty reserved for <code>msg.sender</code> has accumulated in <code>mor.totalPenalty</code>. No actual transfers have occured yet – all the ethers given by the makers as provision are owned by the Mangrove. <code>sendPenalty</code> finally gives the accumulated penalty to <code>msg.sender</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>106
107
108
109
110
111
112
113
114
115</pre></code>
          <pre>    <span class="token function">sendPenalty</span><span class="token punctuation">(</span>mor<span class="token punctuation">.</span>totalPenalty<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">emit</span> <span class="token function">OrderComplete</span><span class="token punctuation">(</span>
      outbound_tkn<span class="token punctuation">,</span>
      inbound_tkn<span class="token punctuation">,</span>
      taker<span class="token punctuation">,</span>
      mor<span class="token punctuation">.</span>totalGot<span class="token punctuation">,</span>
      mor<span class="token punctuation">.</span>totalGave
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>117
118
119</pre></code>
          <pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span>mor<span class="token punctuation">.</span>totalGot<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>totalGave<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-internal-market-order">Internal market order</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>internalMarketOrder</code> works recursively. Going downward, each successive offer is executed until the market order stops (due to: volume exhausted, bad price, or empty book). Then the <a href="#internalMarketOrder/liftReentrancy">reentrancy lock is lifted</a>. Going upward, each offer’s <code>maker</code> contract is called again with its remaining gas and given the chance to update its offers on the book.</p>
<p>The last argument is a boolean named <code>proceed</code>. If an offer was not executed, it means the price has become too high. In that case, we notify the next recursive call that the market order should end. In this initial call, no offer has been executed yet so <code>proceed</code> is true.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>125
126
127
128
129</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">internalMarketOrder</span><span class="token punctuation">(</span>
    MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span>
    ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">,</span>
    <span class="token builtin">bool</span> proceed
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h4>Case 1 : End of order</h4>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We execute the offer currently stored in <code>sor</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>132
133
134
135
136
137
138
139</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      proceed <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span>mor<span class="token punctuation">.</span>fillWants <span class="token operator">?</span> sor<span class="token punctuation">.</span>wants <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">:</span> sor<span class="token punctuation">.</span>gives <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      sor<span class="token punctuation">.</span>offerId <span class="token operator">></span> <span class="token number">0</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> gasused<span class="token punctuation">;</span> <span class="token comment">// gas used by `makerExecute`</span>
      <span class="token builtin">bytes32</span> makerData<span class="token punctuation">;</span> <span class="token comment">// data returned by maker</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="MgvOfferTaking/statusCodes"></a> <code>mgvData</code> is an internal Mangrove status code. It may appear in an <a href="#MgvLib/OrderResult"><code>OrderResult</code></a>. Its possible values are:</p>
<ul>
<li><code>&quot;mgv/notExecuted&quot;</code>: offer was not executed.</li>
<li><code>&quot;mgv/tradeSuccess&quot;</code>: offer execution succeeded. Will appear in <code>OrderResult</code>.</li>
<li><code>&quot;mgv/notEnoughGasForMakerTrade&quot;</code>: cannot give maker close enough to <code>gasreq</code>. Triggers a revert of the entire order.</li>
<li><code>&quot;mgv/makerRevert&quot;</code>: execution of <code>makerExecute</code> reverted. Will appear in <code>OrderResult</code>.</li>
<li><code>&quot;mgv/makerAbort&quot;</code>: execution of <code>makerExecute</code> returned normally, but returndata did not start with 32 bytes of 0s. Will appear in <code>OrderResult</code>.</li>
<li><code>&quot;mgv/makerTransferFail&quot;</code>: maker could not send outbound_tkn tokens. Will appear in <code>OrderResult</code>.</li>
<li><code>&quot;mgv/makerReceiveFail&quot;</code>: maker could not receive inbound_tkn tokens. Will appear in <code>OrderResult</code>.</li>
<li><code>&quot;mgv/takerTransferFail&quot;</code>: taker could not send inbound_tkn tokens. Triggers a revert of the entire order.</li>
</ul>
<p><code>mgvData</code> should not be exploitable by the maker!</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>151
152</pre></code>
          <pre>      <span class="token builtin">bytes32</span> mgvData<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Load additional information about the offer. We don’t do it earlier to save one storage read in case <code>proceed</code> was false.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>154
155
156
157</pre></code>
          <pre>      sor<span class="token punctuation">.</span>offerDetail <span class="token operator">=</span> offerDetails<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>
        sor<span class="token punctuation">.</span>offerId
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>execute</code> will adjust <code>sor.wants</code>,<code>sor.gives</code>, and may attempt to execute the offer if its price is low enough. It is crucial that an error due to <code>taker</code> triggers a revert. That way, <a href="#MgvOfferTaking/statusCodes"><code>mgvData</code></a> not in <code>[&quot;mgv/notExecuted&quot;,&quot;mgv/tradeSuccess&quot;]</code> means the failure is the maker’s fault.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Post-execution, <code>sor.wants</code>/<code>sor.gives</code> reflect how much was sent/taken by the offer. We will need it after the recursive call, so we save it in local variables. Same goes for <code>offerId</code>, <code>sor.offer</code> and <code>sor.offerDetail</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>160
161
162</pre></code>
          <pre>
      <span class="token punctuation">(</span>gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">,</span> mgvData<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">execute</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Keep cached copy of current <code>sor</code> values.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>164
165
166
167
168
169</pre></code>
          <pre>      <span class="token builtin">uint</span> takerWants <span class="token operator">=</span> sor<span class="token punctuation">.</span>wants<span class="token punctuation">;</span>
      <span class="token builtin">uint</span> takerGives <span class="token operator">=</span> sor<span class="token punctuation">.</span>gives<span class="token punctuation">;</span>
      <span class="token builtin">uint</span> offerId <span class="token operator">=</span> sor<span class="token punctuation">.</span>offerId<span class="token punctuation">;</span>
      <span class="token builtin">bytes32</span> offer <span class="token operator">=</span> sor<span class="token punctuation">.</span>offer<span class="token punctuation">;</span>
      <span class="token builtin">bytes32</span> offerDetail <span class="token operator">=</span> sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If an execution was attempted, we move <code>sor</code> to the next offer. Note that the current state is inconsistent, since we have not yet updated <code>sor.offerDetails</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>171
172
173
174</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>mgvData <span class="token operator">!=</span> <span class="token string">"mgv/notExecuted"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sor<span class="token punctuation">.</span>wants <span class="token operator">=</span> mor<span class="token punctuation">.</span>initialWants <span class="token operator">></span> mor<span class="token punctuation">.</span>totalGot
          <span class="token operator">?</span> mor<span class="token punctuation">.</span>initialWants <span class="token operator">-</span> mor<span class="token punctuation">.</span>totalGot
          <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>It is known statically that <code>mor.initialGives - mor.totalGave</code> does not underflow since</p>
<ol>
<li><code>mor.totalGave</code> was increased by <code>sor.gives</code> during <code>execute</code>,</li>
<li><code>sor.gives</code> was at most <code>mor.initialGives - mor.totalGave</code> from earlier step,</li>
<li><code>sor.gives</code> may have been clamped <em>down</em> during <code>execute</code> (to “<code>offer.wants</code>” if the offer is entirely consumed, or to <code>makerWouldWant</code>, cf. code of <code>execute</code>).</li>
</ol>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>180
181
182
183
184</pre></code>
          <pre>        sor<span class="token punctuation">.</span>gives <span class="token operator">=</span> mor<span class="token punctuation">.</span>initialGives <span class="token operator">-</span> mor<span class="token punctuation">.</span>totalGave<span class="token punctuation">;</span>
        sor<span class="token punctuation">.</span>offerId <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offer_next</span><span class="token punctuation">(</span><span class="token string">"sor.offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sor<span class="token punctuation">.</span>offer <span class="token operator">=</span> offers<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>note that internalMarketOrder may be called twice with same offerId, but in that case <code>proceed</code> will be false!</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>186
187
188</pre></code>
          <pre>      <span class="token function">internalMarketOrder</span><span class="token punctuation">(</span>
        mor<span class="token punctuation">,</span>
        sor<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>proceed</code> value for next call. Currently, when an offer did not execute, it’s because the offer’s price was too high. In that case we interrupt the loop and let the taker leave with less than they asked for (but at a correct price). We could also revert instead of breaking; this could be a configurable flag for the taker to pick.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>190
191
192</pre></code>
          <pre>        mgvData <span class="token operator">!=</span> <span class="token string">"mgv/notExecuted"</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Restore <code>sor</code> values from to before recursive call</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>194
195
196
197
198
199</pre></code>
          <pre>      sor<span class="token punctuation">.</span>offerId <span class="token operator">=</span> offerId<span class="token punctuation">;</span>
      sor<span class="token punctuation">.</span>wants <span class="token operator">=</span> takerWants<span class="token punctuation">;</span>
      sor<span class="token punctuation">.</span>gives <span class="token operator">=</span> takerGives<span class="token punctuation">;</span>
      sor<span class="token punctuation">.</span>offer <span class="token operator">=</span> offer<span class="token punctuation">;</span>
      sor<span class="token punctuation">.</span>offerDetail <span class="token operator">=</span> offerDetail<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>After an offer execution, we may run callbacks and increase the total penalty. As that part is common to market orders and snipes, it lives in its own <code>postExecute</code> function.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>201
202
203
204</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>mgvData <span class="token operator">!=</span> <span class="token string">"mgv/notExecuted"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">postExecute</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">,</span> gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">,</span> mgvData<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h4>Case 2 : End of market order</h4>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>proceed</code> is false, the taker has gotten its requested volume, or we have reached the end of the book, we conclude the market order.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>207</pre></code>
          <pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>During the market order, all executed offers have been removed from the book. We end by stitching together the <code>best</code> offer pointer and the new best offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>209
210
211
212
213
214
215</pre></code>
          <pre>      sor<span class="token punctuation">.</span>local <span class="token operator">=</span> <span class="token function">stitchOffers</span><span class="token punctuation">(</span>
        sor<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span>
        sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        sor<span class="token punctuation">.</span>offerId<span class="token punctuation">,</span>
        sor<span class="token punctuation">.</span>local
      <span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="internalMarketOrder/liftReentrancy"></a>Now that the market order is over, we can lift the lock on the book. In the same operation we</p>
<ul>
<li>lift the reentrancy lock, and</li>
<li>update the storage</li>
</ul>
<p>so we are free from out of order storage writes.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>223
224
225</pre></code>
          <pre>      sor<span class="token punctuation">.</span>local <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"sor.local"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"lock"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      locals<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">]</span> <span class="token operator">=</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>payTakerMinusFees</code> sends the fee to the vault, proportional to the amount purchased, and gives the rest to the taker</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>227
228</pre></code>
          <pre>      <span class="token function">payTakerMinusFees</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In an inverted Mangrove, amounts have been lent by each offer’s maker to the taker. We now call the taker. This is a noop in a normal Mangrove.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>230
231
232
233</pre></code>
          <pre>      <span class="token function">executeEnd</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertaking.sol-sniping">Sniping</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-snipes">Snipes</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>snipes</code> executes multiple offers. It takes a <code>uint[4][]</code> as penultimate argument, with each array element of the form <code>[offerId,takerWants,takerGives,offerGasreq]</code>. The return parameters are of the form <code>(successes,totalGot,totalGave)</code>.
Note that we do not distinguish further between mismatched arguments/offer fields on the one hand, and an execution failure on the other. Still, a failed offer has to pay a penalty, and ultimately transaction logs explicitly mention execution failures (see <code>MgvLib.sol</code>).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">snipes</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">calldata</span> targets<span class="token punctuation">,</span>
    <span class="token builtin">bool</span> fillWants
  <span class="token punctuation">)</span>
    <span class="token keyword">external</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span>
      <span class="token builtin">uint</span><span class="token punctuation">,</span>
      <span class="token builtin">uint</span><span class="token punctuation">,</span>
      <span class="token builtin">uint</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">return</span>
      <span class="token function">generalSnipes</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> fillWants<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>From an array of <em>n</em> <code>[offerId, takerWants,takerGives,gasreq]</code> elements, execute each snipe in sequence. Returns <code>(successes, takerGot, takerGave)</code>.</p>
<p>Note that if this function is not internal, anyone can make anyone use Mangrove.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">generalSnipes</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">calldata</span> targets<span class="token punctuation">,</span>
    <span class="token builtin">bool</span> fillWants<span class="token punctuation">,</span>
    <span class="token builtin">address</span> taker
  <span class="token punctuation">)</span>
    <span class="token keyword">internal</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span>
      <span class="token builtin">uint</span><span class="token punctuation">,</span>
      <span class="token builtin">uint</span><span class="token punctuation">,</span>
      <span class="token builtin">uint</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">;</span>
    sor<span class="token punctuation">.</span>outbound_tkn <span class="token operator">=</span> outbound_tkn<span class="token punctuation">;</span>
    sor<span class="token punctuation">.</span>inbound_tkn <span class="token operator">=</span> inbound_tkn<span class="token punctuation">;</span>
    <span class="token punctuation">(</span>sor<span class="token punctuation">.</span>global<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">)</span><span class="token punctuation">;</span>

    MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">;</span>
    mor<span class="token punctuation">.</span>taker <span class="token operator">=</span> taker<span class="token punctuation">;</span>
    mor<span class="token punctuation">.</span>fillWants <span class="token operator">=</span> fillWants<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>For the snipes to even start, the market needs to be both active and not currently protected from reentrancy.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>285
286
287</pre></code>
          <pre>    <span class="token function">activeMarketOnly</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>global<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unlockedMarketOnly</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Main loop</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We start be enabling the reentrancy lock for this (<code>outbound_tkn</code>,<code>inbound_tkn</code>) pair.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>292
293
294</pre></code>
          <pre>    sor<span class="token punctuation">.</span>local <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"sor.local"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"lock"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    locals<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span> <span class="token operator">=</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Call recursive <code>internalSnipes</code> function.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>296
297</pre></code>
          <pre>    <span class="token function">internalSnipes</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Over the course of the snipes order, a penalty reserved for <code>msg.sender</code> has accumulated in <code>mor.totalPenalty</code>. No actual transfers have occured yet – all the ethers given by the makers as provision are owned by the Mangrove. <code>sendPenalty</code> finally gives the accumulated penalty to <code>msg.sender</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>299</pre></code>
          <pre>    <span class="token function">sendPenalty</span><span class="token punctuation">(</span>mor<span class="token punctuation">.</span>totalPenalty<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>301
302
303
304
305
306
307
308
309
310
311
312</pre></code>
          <pre>
    <span class="token keyword">emit</span> <span class="token function">OrderComplete</span><span class="token punctuation">(</span>
      outbound_tkn<span class="token punctuation">,</span>
      inbound_tkn<span class="token punctuation">,</span>
      taker<span class="token punctuation">,</span>
      mor<span class="token punctuation">.</span>totalGot<span class="token punctuation">,</span>
      mor<span class="token punctuation">.</span>totalGave
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>mor<span class="token punctuation">.</span>successCount<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>totalGot<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>totalGave<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-internal-snipes">Internal snipes</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>internalSnipes</code> works recursively. Going downward, each successive offer is executed until each snipe in the array has been tried. Then the reentrancy lock <a href="#internalSnipes/liftReentrancy">is lifted</a>. Going upward, each offer’s <code>maker</code> contract is called again with its remaining gas and given the chance to update its offers on the book.</p>
<p>The last argument is the array index for the current offer. It is initially 0.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>318
319
320
321
322
323</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">internalSnipes</span><span class="token punctuation">(</span>
    MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span>
    ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">,</span>
    <span class="token builtin">uint</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">calldata</span> targets<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> i
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h4>Case 1 : continuation of snipes</h4>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>325
326
327
328
329
330
331</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> targets<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sor<span class="token punctuation">.</span>offerId <span class="token operator">=</span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      sor<span class="token punctuation">.</span>offer <span class="token operator">=</span> offers<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span>
      sor<span class="token punctuation">.</span>offerDetail <span class="token operator">=</span> offerDetails<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>
        sor<span class="token punctuation">.</span>offerId
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If we removed the <code>isLive</code> conditional, a single expired or nonexistent offer in <code>targets</code> would revert the entire transaction (by the division by <code>offer.gives</code> below since <code>offer.gives</code> would be 0). We also check that <code>gasreq</code> is not worse than specified. A taker who does not care about <code>gasreq</code> can specify any amount larger than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>24</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{24}-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>. A mismatched price will be detected by <code>execute</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>333
334
335
336</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token operator">!</span><span class="token function">isLive</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>offer<span class="token punctuation">)</span> <span class="token operator">||</span>
        $$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We move on to the next offer in the array.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354</pre></code>
          <pre>        <span class="token function">internalSnipes</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint</span> gasused<span class="token punctuation">;</span>
        <span class="token builtin">bytes32</span> makerData<span class="token punctuation">;</span>
        <span class="token builtin">bytes32</span> mgvData<span class="token punctuation">;</span>

        <span class="token keyword">require</span><span class="token punctuation">(</span>
          <span class="token builtin">uint96</span><span class="token punctuation">(</span>targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string">"mgv/snipes/takerWants/96bits"</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>
          <span class="token builtin">uint96</span><span class="token punctuation">(</span>targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string">"mgv/snipes/takerGives/96bits"</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        sor<span class="token punctuation">.</span>wants <span class="token operator">=</span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        sor<span class="token punctuation">.</span>gives <span class="token operator">=</span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>execute</code> will adjust <code>sor.wants</code>,<code>sor.gives</code>, and may attempt to execute the offer if its price is low enough. It is crucial that an error due to <code>taker</code> triggers a revert. That way <a href="#MgvOfferTaking/statusCodes"><code>mgvData</code></a> not in <code>[&quot;mgv/tradeSuccess&quot;,&quot;mgv/notExecuted&quot;]</code> means the failure is the maker’s fault.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Post-execution, <code>sor.wants</code>/<code>sor.gives</code> reflect how much was sent/taken by the offer. We will need it after the recursive call, so we save it in local variables. Same goes for <code>offerId</code>, <code>sor.offer</code> and <code>sor.offerDetail</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>357
358</pre></code>
          <pre>        <span class="token punctuation">(</span>gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">,</span> mgvData<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">execute</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In the market order, we were able to avoid stitching back offers after every <code>execute</code> since we knew a continuous segment starting at best would be consumed. Here, we cannot do this optimisation since offers in the <code>targets</code> array may be anywhere in the book. So we stitch together offers immediately after each <code>execute</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>360
361
362
363
364
365
366
367
368
369
370</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mgvData <span class="token operator">!=</span> <span class="token string">"mgv/notExecuted"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          sor<span class="token punctuation">.</span>local <span class="token operator">=</span> <span class="token function">stitchOffers</span><span class="token punctuation">(</span>
            sor<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span>
            sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span>
            $$<span class="token punctuation">(</span><span class="token function">offer_prev</span><span class="token punctuation">(</span><span class="token string">"sor.offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            $$<span class="token punctuation">(</span><span class="token function">offer_next</span><span class="token punctuation">(</span><span class="token string">"sor.offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            sor<span class="token punctuation">.</span>local
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Keep cached copy of current <code>sor</code> values.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>372
373
374
375
376
377</pre></code>
          <pre>          <span class="token builtin">uint</span> offerId <span class="token operator">=</span> sor<span class="token punctuation">.</span>offerId<span class="token punctuation">;</span>
          <span class="token builtin">uint</span> takerWants <span class="token operator">=</span> sor<span class="token punctuation">.</span>wants<span class="token punctuation">;</span>
          <span class="token builtin">uint</span> takerGives <span class="token operator">=</span> sor<span class="token punctuation">.</span>gives<span class="token punctuation">;</span>
          <span class="token builtin">bytes32</span> offer <span class="token operator">=</span> sor<span class="token punctuation">.</span>offer<span class="token punctuation">;</span>
          <span class="token builtin">bytes32</span> offerDetail <span class="token operator">=</span> sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We move on to the next offer in the array.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>379
380</pre></code>
          <pre>          <span class="token function">internalSnipes</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Restore <code>sor</code> values from to before recursive call</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>382
383
384
385
386
387
388</pre></code>
          <pre>          sor<span class="token punctuation">.</span>offerId <span class="token operator">=</span> offerId<span class="token punctuation">;</span>
          sor<span class="token punctuation">.</span>wants <span class="token operator">=</span> takerWants<span class="token punctuation">;</span>
          sor<span class="token punctuation">.</span>gives <span class="token operator">=</span> takerGives<span class="token punctuation">;</span>
          sor<span class="token punctuation">.</span>offer <span class="token operator">=</span> offer<span class="token punctuation">;</span>
          sor<span class="token punctuation">.</span>offerDetail <span class="token operator">=</span> offerDetail<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>After an offer execution, we may run callbacks and increase the total penalty. As that part is common to market orders and snipes, it lives in its own <code>postExecute</code> function.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>390
391
392
393</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mgvData <span class="token operator">!=</span> <span class="token string">"mgv/notExecuted"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">postExecute</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">,</span> gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">,</span> mgvData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h4>Case 2 : End of snipes</h4>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>395</pre></code>
          <pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="internalSnipes/liftReentrancy"></a> Now that the snipes is over, we can lift the lock on the book. In the same operation we</p>
<ul>
<li>lift the reentrancy lock, and</li>
<li>update the storage</li>
</ul>
<p>so we are free from out of order storage writes.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>402
403</pre></code>
          <pre>      sor<span class="token punctuation">.</span>local <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"sor.local"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"lock"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      locals<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">]</span> <span class="token operator">=</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>payTakerMinusFees</code> sends the fee to the vault, proportional to the amount purchased, and gives the rest to the taker</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>405</pre></code>
          <pre>      <span class="token function">payTakerMinusFees</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In an inverted Mangrove, amounts have been lent by each offer’s maker to the taker. We now call the taker. This is a noop in a normal Mangrove.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>407
408
409
410</pre></code>
          <pre>      <span class="token function">executeEnd</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertaking.sol-general-execution">General execution</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>During a market order or a snipes, offers get executed. The following code takes care of executing a single offer with parameters given by a <code>SingleOrder</code> within a larger context given by a <code>MultiOrder</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-execute">Execute</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This function will compare <code>sor.wants</code> <code>sor.gives</code> with <code>sor.offer.wants</code> and <code>sor.offer.gives</code>. If the price of the offer is low enough, an execution will be attempted (with volume limited by the offer’s advertised volume).</p>
<p>Summary of the meaning of the return values:</p>
<ul>
<li><code>gasused</code> is the gas consumed by the execution</li>
<li><code>makerData</code> is the data returned after executing the offer</li>
<li><code>mgvData</code> is an <a href="#MgvOfferTaking/statusCodes">internal Mangrove status code</a>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>422
423
424
425
426
427
428
429</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">execute</span><span class="token punctuation">(</span>MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span> ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span>
    <span class="token keyword">internal</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span>
      <span class="token builtin">uint</span> gasused<span class="token punctuation">,</span>
      <span class="token builtin">bytes32</span> makerData<span class="token punctuation">,</span>
      <span class="token builtin">bytes32</span> mgvData
    <span class="token punctuation">)</span>
  <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h4><code>Price comparison</code></h4>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The current offer has a price <code>p = offerWants ÷ offerGives</code> and the taker is ready to accept a price up to <code>p' = takerGives ÷ takerWants</code>. Comparing <code>offerWants * takerWants</code> and <code>offerGives * takerGives</code> tels us whether <code>p &lt; p'</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>434
435
436
437
438</pre></code>
          <pre>    <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> offerWants <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offer_wants</span><span class="token punctuation">(</span><span class="token string">"sor.offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">uint</span> offerGives <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offer_gives</span><span class="token punctuation">(</span><span class="token string">"sor.offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">uint</span> takerWants <span class="token operator">=</span> sor<span class="token punctuation">.</span>wants<span class="token punctuation">;</span>
      <span class="token builtin">uint</span> takerGives <span class="token operator">=</span> sor<span class="token punctuation">.</span>gives<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="MgvOfferTaking/checkPrice"></a>If the price is too high, we return early.</p>
<p>Otherwise we now know we’ll execute the offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>442
443
444
445</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>offerWants <span class="token operator">*</span> takerWants <span class="token operator">></span> offerGives <span class="token operator">*</span> takerGives<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/notExecuted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Specification of value transfers:</h3>
<p>Let <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>o</mi><mi>w</mi></msub></mrow><annotation encoding="application/x-tex">o_w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> be <code>offerWants</code>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>o</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">o_g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> be <code>offerGives</code>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>w</mi></msub></mrow><annotation encoding="application/x-tex">t_w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> be <code>takerWants</code>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">t_g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> be <code>takerGives</code>, and <code>f ∈ {w,g}</code> be <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>w</mi></mrow><annotation encoding="application/x-tex">w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> if <code>fillWants</code> is true, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span> otherwise.</p>
<p>Let <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>got</mtext></mrow><annotation encoding="application/x-tex">\textrm{got}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80952em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">got</span></span></span></span></span> be the amount that the taker will receive, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>gave</mtext></mrow><annotation encoding="application/x-tex">\textrm{gave}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">gave</span></span></span></span></span> be the amount that the taker will pay.</p>
<h4>Case <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo>=</mo><mi>w</mi></mrow><annotation encoding="application/x-tex">f = w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span></h4>
<p>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo>=</mo><mi>w</mi></mrow><annotation encoding="application/x-tex">f = w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span>, let <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>got</mtext><mo>=</mo><mi>min</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>o</mi><mi>g</mi></msub><mo separator="true">,</mo><msub><mi>t</mi><mi>w</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\textrm{got} = \min(o_g,t_w)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80952em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">got</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mop">min</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, and let <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>gave</mtext><mo>=</mo><mrow><mo fence="true">⌈</mo><mstyle displaystyle="true" scriptlevel="0"><mfrac><mrow><msub><mi>o</mi><mi>w</mi></msub><mtext>got</mtext></mrow><msub><mi>o</mi><mi>g</mi></msub></mfrac></mstyle><mo fence="true">⌉</mo></mrow></mrow><annotation encoding="application/x-tex">\textrm{gave} = \left\lceil\dfrac{o_w \textrm{got}}{o_g}\right\rceil</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">gave</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.4221079999999997em;vertical-align:-0.972108em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">⌈</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.29208em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord text"><span class="mord textrm">got</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.972108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">⌉</span></span></span></span></span></span>. This is well-defined since, for live offers, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>o</mi><mi>g</mi></msub><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">o_g &gt; 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8252079999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>.</p>
<p>In plain english, we only give to the taker up to what they wanted (or what the offer has to give), and follow the offer price to determine what the taker will give.</p>
<p>Since <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>gave</mtext></mrow><annotation encoding="application/x-tex">\textrm{gave}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">gave</span></span></span></span></span> is rounded up, the price might be overevaluated. Still, we cannot spend more than what the taker specified as <code>takerGives</code>. At this point <a href="#MgvOfferTaking/checkPrice">we know</a> that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>o</mi><mi>w</mi></msub><msub><mi>t</mi><mi>w</mi></msub><mo>≤</mo><msub><mi>o</mi><mi>g</mi></msub><msub><mi>t</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">o_w t_w \leq o_g t_g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7859700000000001em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>, so since <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">t_g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> is an integer we have</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>g</mi></msub><mo>≥</mo><mrow><mo fence="true">⌈</mo><mstyle displaystyle="true" scriptlevel="0"><mfrac><mrow><msub><mi>o</mi><mi>w</mi></msub><msub><mi>t</mi><mi>w</mi></msub></mrow><msub><mi>o</mi><mi>g</mi></msub></mfrac></mstyle><mo fence="true">⌉</mo></mrow><mo>≥</mo><mrow><mo fence="true">⌈</mo><mstyle displaystyle="true" scriptlevel="0"><mfrac><mrow><msub><mi>o</mi><mi>w</mi></msub><mtext>got</mtext></mrow><msub><mi>o</mi><mi>g</mi></msub></mfrac></mstyle><mo fence="true">⌉</mo></mrow><mo>=</mo><mtext>gave</mtext></mrow><annotation encoding="application/x-tex">t_g \geq \left\lceil\dfrac{o_w t_w}{o_g}\right\rceil \geq \left\lceil\dfrac{o_w \textrm{got}}{o_g}\right\rceil = \textrm{gave}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.922078em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.4221079999999997em;vertical-align:-0.972108em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">⌈</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.29208em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.972108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">⌉</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.4221079999999997em;vertical-align:-0.972108em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">⌈</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.29208em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord text"><span class="mord textrm">got</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.972108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">⌉</span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">gave</span></span></span></span></span>.</p>
<h4>Case <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo>=</mo><mi>g</mi></mrow><annotation encoding="application/x-tex">f = g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span></h4>
<p>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo>=</mo><mi>g</mi></mrow><annotation encoding="application/x-tex">f = g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span>, let <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>gave</mtext><mo>=</mo><mi>min</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>o</mi><mi>w</mi></msub><mo separator="true">,</mo><msub><mi>t</mi><mi>g</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\textrm{gave} = \min(o_w,t_g)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">gave</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mop">min</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>got</mtext><mo>=</mo><msub><mi>o</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">\textrm{got} = o_g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80952em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">got</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>o</mi><mi>w</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">o_w = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>got</mtext><mo>=</mo><mrow><mo fence="true">⌊</mo><mstyle displaystyle="true" scriptlevel="0"><mfrac><mrow><msub><mi>o</mi><mi>g</mi></msub><mtext>gave</mtext></mrow><msub><mi>o</mi><mi>w</mi></msub></mfrac></mstyle><mo fence="true">⌋</mo></mrow></mrow><annotation encoding="application/x-tex">\textrm{got} = \left\lfloor\dfrac{o_g \textrm{gave}}{o_w}\right\rfloor</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80952em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">got</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.40003em;vertical-align:-0.95003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">⌊</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1075599999999999em;"><span style="top:-2.3139999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord text"><span class="mord textrm">gave</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8360000000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">⌋</span></span></span></span></span></span> otherwise.</p>
<p>In plain english, we spend up to what the taker agreed to pay (or what the offer wants), and follow the offer price to determine what the taker will get. This may exceed <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>w</mi></msub></mrow><annotation encoding="application/x-tex">t_w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p>
<h4>Price adjustment</h4>
<p>Prices are rounded up to ensure maker is not drained on small amounts. It’s economically unlikely, but <code>density</code> protects the taker from being drained anyway so it is better to default towards protecting the maker here.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Implementation</h3>
<p>First we check the cases <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>f</mi><mo>=</mo><mi>w</mi><mo>∧</mo><msub><mi>o</mi><mi>g</mi></msub><mo>&lt;</mo><msub><mi>t</mi><mi>w</mi></msub><mo stretchy="false">)</mo><mo>∨</mo><mo stretchy="false">(</mo><msub><mi>f</mi><mi>g</mi></msub><mo>∧</mo><msub><mi>o</mi><mi>w</mi></msub><mo>&lt;</mo><msub><mi>t</mi><mi>g</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(f=w \wedge o_g &lt; t_w)\vee(f_g \wedge o_w &lt; t_g)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.55556em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8252079999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∨</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∧</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>, in which case the above spec simplifies to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>got</mtext><mo>=</mo><msub><mi>o</mi><mi>g</mi></msub><mo separator="true">,</mo><mtext>gave</mtext><mo>=</mo><msub><mi>o</mi><mi>w</mi></msub></mrow><annotation encoding="application/x-tex">\textrm{got} = o_g, \textrm{gave} = o_w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80952em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">got</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord textrm">gave</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>.</p>
<p>Otherwise the offer may be partially consumed.</p>
<p>In the case <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo>=</mo><mi>w</mi></mrow><annotation encoding="application/x-tex">f=w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span> we don’t touch <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>got</mtext></mrow><annotation encoding="application/x-tex">\textrm{got}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80952em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">got</span></span></span></span></span> (which was initialized to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>w</mi></msub></mrow><annotation encoding="application/x-tex">t_w</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>) and compute <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>gave</mtext><mo>=</mo><mrow><mo fence="true">⌈</mo><mstyle displaystyle="true" scriptlevel="0"><mfrac><mrow><msub><mi>o</mi><mi>w</mi></msub><msub><mi>t</mi><mi>w</mi></msub></mrow><msub><mi>o</mi><mi>g</mi></msub></mfrac></mstyle><mo fence="true">⌉</mo></mrow></mrow><annotation encoding="application/x-tex">\textrm{gave} = \left\lceil\dfrac{o_w t_w}{o_g}\right\rceil</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">gave</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.4221079999999997em;vertical-align:-0.972108em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">⌈</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.29208em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.972108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">⌉</span></span></span></span></span></span>. As shown above we have <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>gave</mtext><mo>≤</mo><msub><mi>t</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">\textrm{gave} \leq t_g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8304100000000001em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">gave</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>.</p>
<p>In the case <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo>=</mo><mi>g</mi></mrow><annotation encoding="application/x-tex">f=g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span></span></span></span> we don’t touch <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>gave</mtext></mrow><annotation encoding="application/x-tex">\textrm{gave}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">gave</span></span></span></span></span> (which was initialized to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">t_g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9011879999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>) and compute <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>got</mtext><mo>=</mo><msub><mi>o</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">\textrm{got} = o_g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80952em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">got</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> if <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>o</mi><mi>w</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">o_w = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>, and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>got</mtext><mo>=</mo><mrow><mo fence="true">⌊</mo><mstyle displaystyle="true" scriptlevel="0"><mfrac><mrow><msub><mi>o</mi><mi>g</mi></msub><msub><mi>t</mi><mi>g</mi></msub></mrow><msub><mi>o</mi><mi>w</mi></msub></mfrac></mstyle><mo fence="true">⌋</mo></mrow></mrow><annotation encoding="application/x-tex">\textrm{got} = \left\lfloor\dfrac{o_g t_g}{o_w}\right\rfloor</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.80952em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">got</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.40003em;vertical-align:-0.95003em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">⌊</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.29208em;"><span style="top:-2.3139999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8360000000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">⌋</span></span></span></span></span></span> otherwise.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token punctuation">(</span>mor<span class="token punctuation">.</span>fillWants <span class="token operator">&amp;&amp;</span> offerGives <span class="token operator">&lt;</span> takerWants<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span><span class="token operator">!</span>mor<span class="token punctuation">.</span>fillWants <span class="token operator">&amp;&amp;</span> offerWants <span class="token operator">&lt;</span> takerGives<span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sor<span class="token punctuation">.</span>wants <span class="token operator">=</span> offerGives<span class="token punctuation">;</span>
        sor<span class="token punctuation">.</span>gives <span class="token operator">=</span> offerWants<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mor<span class="token punctuation">.</span>fillWants<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token builtin">uint</span> product <span class="token operator">=</span> offerWants <span class="token operator">*</span> takerWants<span class="token punctuation">;</span>
          sor<span class="token punctuation">.</span>gives <span class="token operator">=</span>
            product <span class="token operator">/</span>
            offerGives <span class="token operator">+</span>
            <span class="token punctuation">(</span>product <span class="token operator">%</span> offerGives <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>offerWants <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sor<span class="token punctuation">.</span>wants <span class="token operator">=</span> offerGives<span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            sor<span class="token punctuation">.</span>wants <span class="token operator">=</span> <span class="token punctuation">(</span>offerGives <span class="token operator">*</span> takerGives<span class="token punctuation">)</span> <span class="token operator">/</span> offerWants<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The flashloan is executed by call to <code>flashloan</code>. If the call reverts, it means the maker failed to send back <code>sor.wants</code> <code>outbound_tkn</code> to the taker. Notes :</p>
<ul>
<li><code>msg.sender</code> is the Mangrove itself in those calls – all operations related to the actual caller should be done outside of this call.</li>
<li>any spurious exception due to an error in Mangrove code will be falsely blamed on the Maker, and its provision for the offer will be unfairly taken away.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>511
512
513
514</pre></code>
          <pre>    <span class="token punctuation">(</span><span class="token builtin">bool</span> success<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> retdata<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
      abi<span class="token punctuation">.</span><span class="token function">encodeWithSelector</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>flashloan<span class="token punctuation">.</span>selector<span class="token punctuation">,</span> sor<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>taker<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>success</code> is true: trade is complete</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>516
517</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mor<span class="token punctuation">.</span>successCount <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In case of success, <code>retdata</code> encodes the gas used by the offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>519</pre></code>
          <pre>      gasused <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>retdata<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>mgvData</code> indicates trade success</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>521
522
523
524
525
526
527
528
529
530</pre></code>
          <pre>      mgvData <span class="token operator">=</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token string">"mgv/tradeSuccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">OfferSuccess</span><span class="token punctuation">(</span>
        sor<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span>
        sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span>
        sor<span class="token punctuation">.</span>offerId<span class="token punctuation">,</span>
        mor<span class="token punctuation">.</span>taker<span class="token punctuation">,</span>
        sor<span class="token punctuation">.</span>wants<span class="token punctuation">,</span>
        sor<span class="token punctuation">.</span>gives
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If configured to do so, the Mangrove notifies an external contract that a successful trade has taken place.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>532
533
534
535
536
537
538</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">global_notify</span><span class="token punctuation">(</span><span class="token string">"sor.global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">IMgvMonitor</span><span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">global_monitor</span><span class="token punctuation">(</span><span class="token string">"sor.global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notifySuccess</span><span class="token punctuation">(</span>
          sor<span class="token punctuation">,</span>
          mor<span class="token punctuation">.</span>taker
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We update the totals in the multiorder based on the adjusted <code>sor.wants</code>/<code>sor.gives</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>overflow: sor.{wants,gives} are on 96bits, sor.total{Got,Gave} are on 256 bits.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>541
542
543</pre></code>
          <pre>      mor<span class="token punctuation">.</span>totalGot <span class="token operator">+=</span> sor<span class="token punctuation">.</span>wants<span class="token punctuation">;</span>
      mor<span class="token punctuation">.</span>totalGave <span class="token operator">+=</span> sor<span class="token punctuation">.</span>gives<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In case of failure, <code>retdata</code> encodes a short <a href="#MgvOfferTaking/statusCodes">status code</a>, the gas used by the offer, and an arbitrary 256 bits word sent by the maker.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>545</pre></code>
          <pre>      <span class="token punctuation">(</span>mgvData<span class="token punctuation">,</span> gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">innerDecode</span><span class="token punctuation">(</span>retdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Note that in the <code>if</code>s, the literals are bytes32 (stack values), while as revert arguments, they are strings (memory pointers).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        mgvData <span class="token operator">==</span> <span class="token string">"mgv/makerRevert"</span> <span class="token operator">||</span>
        mgvData <span class="token operator">==</span> <span class="token string">"mgv/makerAbort"</span> <span class="token operator">||</span>
        mgvData <span class="token operator">==</span> <span class="token string">"mgv/makerTransferFail"</span> <span class="token operator">||</span>
        mgvData <span class="token operator">==</span> <span class="token string">"mgv/makerReceiveFail"</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mor<span class="token punctuation">.</span>failCount <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">emit</span> <span class="token function">OfferFail</span><span class="token punctuation">(</span>
          sor<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span>
          sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span>
          sor<span class="token punctuation">.</span>offerId<span class="token punctuation">,</span>
          mor<span class="token punctuation">.</span>taker<span class="token punctuation">,</span>
          sor<span class="token punctuation">.</span>wants<span class="token punctuation">,</span>
          sor<span class="token punctuation">.</span>gives<span class="token punctuation">,</span>
          mgvData
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If configured to do so, the Mangrove notifies an external contract that a failed trade has taken place.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>566
567
568
569
570
571</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">global_notify</span><span class="token punctuation">(</span><span class="token string">"sor.global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">IMgvMonitor</span><span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">global_monitor</span><span class="token punctuation">(</span><span class="token string">"sor.global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notifyFail</span><span class="token punctuation">(</span>
            sor<span class="token punctuation">,</span>
            mor<span class="token punctuation">.</span>taker
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>It is crucial that any error code which indicates an error caused by the taker triggers a revert, because functions that call <code>execute</code> consider that <code>mgvData</code> not in <code>[&quot;mgv/notExecuted&quot;,&quot;mgv/tradeSuccess&quot;]</code> should be blamed on the maker.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>573
574
575
576
577</pre></code>
          <pre>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mgvData <span class="token operator">==</span> <span class="token string">"mgv/notEnoughGasForMakerTrade"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token string">"mgv/notEnoughGasForMakerTrade"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mgvData <span class="token operator">==</span> <span class="token string">"mgv/takerTransferFail"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token string">"mgv/takerTransferFail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This code must be unreachable. <strong>Danger</strong>: if a well-crafted offer/maker pair can force a revert of <code>flashloan</code>, the Mangrove will be stuck.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>579
580
581
582</pre></code>
          <pre>        <span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token string">"mgv/swapError"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Delete the offer. The last argument indicates whether the offer should be stripped of its provision (yes if execution failed, no otherwise). We delete offers whether the amount remaining on offer is &gt; density or not for the sake of uniformity (code is much simpler). We also expect prices to move often enough that the maker will want to update their price anyway. To simulate leaving the remaining volume in the offer, the maker can program their <code>makerPosthook</code> to <code>updateOffer</code> and put the remaining volume back in.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>584
585
586
587
588
589
590
591
592</pre></code>
          <pre>    <span class="token function">dirtyDeleteOffer</span><span class="token punctuation">(</span>
      sor<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span>
      sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span>
      sor<span class="token punctuation">.</span>offerId<span class="token punctuation">,</span>
      sor<span class="token punctuation">.</span>offer<span class="token punctuation">,</span>
      mgvData <span class="token operator">!=</span> <span class="token string">"mgv/tradeSuccess"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-flashloan-(abstract)">flashloan (abstract)</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Externally called by <code>execute</code>, flashloan lends money (from the taker to the maker, or from the maker to the taker, depending on the implementation) then calls <code>makerExecute</code> to run the maker liquidity fetching code. If <code>makerExecute</code> is unsuccessful, <code>flashloan</code> reverts (but the larger orderbook traversal will continue).</p>
<p>All <code>flashloan</code> implementations must <code>require(msg.sender) == address(this))</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>597
598
599
600
601</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">flashloan</span><span class="token punctuation">(</span>ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> sor<span class="token punctuation">,</span> <span class="token builtin">address</span> taker<span class="token punctuation">)</span>
    <span class="token keyword">external</span>
    virtual
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> gasused<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-maker-execute">Maker Execute</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Called by <code>flashloan</code>, <code>makerExecute</code> runs the maker code and checks that it can safely send the desired assets to the taker.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>604
605
606
607
608
609
610
611
612
613</pre></code>
          <pre>
  <span class="token keyword">function</span> <span class="token function">makerExecute</span><span class="token punctuation">(</span>ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> sor<span class="token punctuation">)</span>
    <span class="token keyword">internal</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> gasused<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> cd <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodeWithSelector</span><span class="token punctuation">(</span>IMaker<span class="token punctuation">.</span>makerExecute<span class="token punctuation">.</span>selector<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">uint</span> gasreq <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">address</span> maker <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_maker</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">uint</span> oldGas <span class="token operator">=</span> <span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We let the maker pay for the overhead of checking remaining gas and making the call, as well as handling the return data (constant gas since only the first 32 bytes of return data are read). So the <code>require</code> below is just an approximation: if the overhead of (<code>require</code> + cost of <code>CALL</code>) is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span>, the maker will receive at worst <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>gasreq</mtext><mo>−</mo><mfrac><mrow><mn>63</mn><mi>h</mi></mrow><mn>64</mn></mfrac></mrow><annotation encoding="application/x-tex">\textrm{gasreq} - \frac{63h}{64}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">gasreq</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.2251079999999999em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> gas.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Note : as a possible future feature, we could stop an order when there’s not enough gas left to continue processing offers. This could be done safely by checking, as soon as we start processing an offer, whether <code>63/64(gasleft-overhead_gasbase-offer_gasbase) &gt; gasreq</code>. If no, we could stop and know by induction that there is enough gas left to apply fees, stitch offers, etc for the offers already executed.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>616
617
618
619
620
621
622
623
624
625
626
627</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>oldGas <span class="token operator">-</span> oldGas <span class="token operator">/</span> <span class="token number">64</span> <span class="token operator">>=</span> gasreq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">innerRevert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token string">"mgv/notEnoughGasForMakerTrade"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">(</span><span class="token builtin">bool</span> callSuccess<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> makerData<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">controlledCall</span><span class="token punctuation">(</span>maker<span class="token punctuation">,</span> gasreq<span class="token punctuation">,</span> cd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    gasused <span class="token operator">=</span> oldGas <span class="token operator">-</span> <span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>callSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">innerRevert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token string">"mgv/makerRevert"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span>gasused<span class="token punctuation">)</span><span class="token punctuation">,</span> makerData<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Successful execution must have a returndata that begins with <code>bytes32(&quot;&quot;)</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>makerData <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">innerRevert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token string">"mgv/makerAbort"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span>gasused<span class="token punctuation">)</span><span class="token punctuation">,</span> makerData<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token builtin">bool</span> transferSuccess <span class="token operator">=</span> <span class="token function">transferTokenFrom</span><span class="token punctuation">(</span>
      sor<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span>
      maker<span class="token punctuation">,</span>
      <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      sor<span class="token punctuation">.</span>wants
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>transferSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">innerRevert</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token string">"mgv/makerTransferFail"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span>gasused<span class="token punctuation">)</span><span class="token punctuation">,</span> makerData<span class="token punctuation">]</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-executeend-(abstract)">executeEnd (abstract)</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Called by <code>internalSnipes</code> and <code>internalMarketOrder</code>, <code>executeEnd</code> may run implementation-specific code after all makers have been called once. In <a href="#InvertedMangrove"><code>InvertedMangrove</code></a>, the function calls the taker once so they can act on their flashloan. In [<code>Mangrove</code>], it does nothing.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>650
651
652
653</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">executeEnd</span><span class="token punctuation">(</span>MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span> ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span>
    <span class="token keyword">internal</span>
    virtual<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-post-execute">Post execute</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>At this point, we know <code>mgvData != &quot;mgv/notExecuted&quot;</code>. After executing an offer (whether in a market order or in snipes), we</p>
<ol>
<li>Call the maker’s posthook and sum the total gas used.</li>
<li>If offer failed: sum total penalty due to taker and give remainder to maker.</li>
</ol>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>659
660
661
662
663
664
665
666
667
668
669
670
671</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">postExecute</span><span class="token punctuation">(</span>
    MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span>
    ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasused<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> makerData<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> mgvData
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mgvData <span class="token operator">==</span> <span class="token string">"mgv/tradeSuccess"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">beforePosthook</span><span class="token punctuation">(</span>sor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token builtin">uint</span> gasreq <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We are about to call back the maker, giving it its unused gas (<code>gasreq - gasused</code>). Since the gas used so far may exceed <code>gasreq</code>, we prevent underflow in the subtraction below by bounding <code>gasused</code> above with <code>gasreq</code>. We could have decided not to call back the maker at all when there is no gas left, but we do it for uniformity.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>673
674
675
676
677
678
679
680
681
682
683
684
685</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>gasused <span class="token operator">></span> gasreq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      gasused <span class="token operator">=</span> gasreq<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    gasused <span class="token operator">=</span>
      gasused <span class="token operator">+</span>
      <span class="token function">makerPosthook</span><span class="token punctuation">(</span>sor<span class="token punctuation">,</span> gasreq <span class="token operator">-</span> gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">,</span> mgvData<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mgvData <span class="token operator">!=</span> <span class="token string">"mgv/tradeSuccess"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mor<span class="token punctuation">.</span>totalPenalty <span class="token operator">+=</span> <span class="token function">applyPenalty</span><span class="token punctuation">(</span>sor<span class="token punctuation">,</span> gasused<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>failCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-beforeposthook-(abstract)">beforePosthook (abstract)</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Called by <code>makerPosthook</code>, this function can run implementation-specific code before calling the maker has been called a second time. In <a href="#InvertedMangrove"><code>InvertedMangrove</code></a>, all makers are called once so the taker gets all of its money in one shot. Then makers are traversed again and the money is sent back to each taker using <code>beforePosthook</code>. In <a href="#Mangrove"><code>Mangrove</code></a>, <code>beforePosthook</code> does nothing.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>688
689
690</pre></code>
          <pre>
  <span class="token keyword">function</span> <span class="token function">beforePosthook</span><span class="token punctuation">(</span>ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span> <span class="token keyword">internal</span> virtual<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-maker-posthook">Maker Posthook</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>692
693
694
695
696
697</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">makerPosthook</span><span class="token punctuation">(</span>
    ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasLeft<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> makerData<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> mgvData
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> gasused<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>At this point, mgvData can only be <code>&quot;mgv/tradeSuccess&quot;</code>, <code>&quot;mgv/makerAbort&quot;</code>, <code>&quot;mgv/makerRevert&quot;</code>, <code>&quot;mgv/makerTransferFail&quot;</code> or <code>&quot;mgv/makerReceiveFail&quot;</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>699
700
701
702
703
704
705
706
707</pre></code>
          <pre>    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> cd <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodeWithSelector</span><span class="token punctuation">(</span>
      IMaker<span class="token punctuation">.</span>makerPosthook<span class="token punctuation">.</span>selector<span class="token punctuation">,</span>
      sor<span class="token punctuation">,</span>
      ML<span class="token punctuation">.</span><span class="token function">OrderResult</span><span class="token punctuation">(</span><span class="token punctuation">{</span>makerData<span class="token punctuation">:</span> makerData<span class="token punctuation">,</span> mgvData<span class="token punctuation">:</span> mgvData<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">address</span> maker <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_maker</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">uint</span> oldGas <span class="token operator">=</span> <span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We let the maker pay for the overhead of checking remaining gas and making the call. So the <code>require</code> below is just an approximation: if the overhead of (<code>require</code> + cost of <code>CALL</code>) is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span>, the maker will receive at worst <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>gasreq</mtext><mo>−</mo><mfrac><mrow><mn>63</mn><mi>h</mi></mrow><mn>64</mn></mfrac></mrow><annotation encoding="application/x-tex">\textrm{gasreq} - \frac{63h}{64}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">gasreq</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.2251079999999999em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> gas.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>709
710
711
712
713
714
715
716
717
718
719
720
721</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>oldGas <span class="token operator">-</span> oldGas <span class="token operator">/</span> <span class="token number">64</span> <span class="token operator">>=</span> gasLeft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token string">"mgv/notEnoughGasForMakerPosthook"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">(</span><span class="token builtin">bool</span> callSuccess<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">controlledCall</span><span class="token punctuation">(</span>maker<span class="token punctuation">,</span> gasLeft<span class="token punctuation">,</span> cd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    gasused <span class="token operator">=</span> oldGas <span class="token operator">-</span> <span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>callSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">emit</span> <span class="token function">PosthookFail</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>offerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-controlledcall"><code>controlledCall</code></h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Calls an external function with controlled gas expense. A direct call of the form <code>(,bytes memory retdata) = maker.call{gas}(selector,...args)</code> enables a griefing attack: the maker uses half its gas to write in its memory, then reverts with that memory segment as argument. After a low-level call, solidity automaticaly copies <code>returndatasize</code> bytes of <code>returndata</code> into memory. So the total gas consumed to execute a failing offer could exceed <code>gasreq + overhead_gasbase/n + offer_gasbase</code> where <code>n</code> is the number of failing offers. This yul call only retrieves the first 32 bytes of the maker’s <code>returndata</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>724
725
726
727
728
729
730
731
732
733
734
735
736
737</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">controlledCall</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> callee<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasreq<span class="token punctuation">,</span>
    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> cd
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span> success<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">bytes32</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> retdata<span class="token punctuation">;</span>

    <span class="token keyword">assembly</span> <span class="token punctuation">{</span>
      success <span class="token operator">:=</span> <span class="token function">call</span><span class="token punctuation">(</span>gasreq<span class="token punctuation">,</span> callee<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>cd<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mload</span><span class="token punctuation">(</span>cd<span class="token punctuation">)</span><span class="token punctuation">,</span> retdata<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    data <span class="token operator">=</span> retdata<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertaking.sol-penalties">Penalties</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Offers are just promises. They can fail. Penalty provisioning discourages from failing too much: we ask makers to provision more ETH than the expected gas cost of executing their offer and penalize them accoridng to wasted gas.</p>
<p>Under normal circumstances, we should expect to see bots with a profit expectation dry-running offers locally and executing <code>snipe</code> on failing offers, collecting the penalty. The result should be a mostly clean book for actual takers (i.e. a book with only successful offers).</p>
<p><strong>Incentive issue</strong>: if the gas price increases enough after an offer has been created, there may not be an immediately profitable way to remove the fake offers. In that case, we count on 3 factors to keep the book clean:</p>
<ol>
<li>Gas price eventually comes down.</li>
<li>Other market makers want to keep the Mangrove attractive and maintain their offer flow.</li>
<li>Mangrove governance (who may collect a fee) wants to keep the Mangrove attractive and maximize exchange volume.</li>
</ol>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>After an offer failed, part of its provision is given back to the maker and the rest is stored to be sent to the taker after the entire order completes. In <code>applyPenalty</code>, we <em>only</em> credit the maker with its excess provision. So it looks like the maker is gaining something. In fact they’re just getting back a fraction of what they provisioned earlier.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Penalty application summary:</p>
<ul>
<li>If the transaction was a success, we entirely refund the maker and send nothing to the taker.</li>
<li>Otherwise, the maker loses the cost of <code>gasused + overhead_gasbase/n + offer_gasbase</code> gas, where <code>n</code> is the number of failed offers. The gas price is estimated by <code>gasprice</code>.</li>
<li>To create the offer, the maker had to provision for <code>gasreq + overhead_gasbase/n + offer_gasbase</code> gas at a price of <code>offer.gasprice</code>.</li>
<li>We do not consider the tx.gasprice.</li>
<li><code>offerDetail.gasbase</code> and <code>offer.gasprice</code> are the values of the Mangrove parameters <code>config.*_gasbase</code> and <code>config.gasprice</code> when the offer was created. Without caching those values, the provision set aside could end up insufficient to reimburse the maker (or to retribute the taker).</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>759
760
761
762
763
764
765
766
767
768
769
770
771</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">applyPenalty</span><span class="token punctuation">(</span>
    ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasused<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> failCount
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint</span> gasreq <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">uint</span> provision <span class="token operator">=</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">9</span> <span class="token operator">*</span>
      $$<span class="token punctuation">(</span><span class="token function">offer_gasprice</span><span class="token punctuation">(</span><span class="token string">"sor.offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span>
      <span class="token punctuation">(</span>gasreq <span class="token operator">+</span>
        $$<span class="token punctuation">(</span><span class="token function">offerDetail_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
        $$<span class="token punctuation">(</span><span class="token function">offerDetail_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We set <code>gasused = min(gasused,gasreq)</code> since <code>gasreq &lt; gasused</code> is possible e.g. with <code>gasreq = 0</code> (all calls consume nonzero gas).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>773
774
775
776</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>gasused <span class="token operator">></span> gasreq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      gasused <span class="token operator">=</span> gasreq<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>As an invariant, <code>applyPenalty</code> is only called when <code>mgvData</code> is not in <code>[&quot;mgv/notExecuted&quot;,&quot;mgv/tradeSuccess&quot;]</code>, and thus when <code>failCount &gt; 0</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>778
779
780
781
782
783
784
785
786
787
788</pre></code>
          <pre>    <span class="token builtin">uint</span> penalty <span class="token operator">=</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">9</span> <span class="token operator">*</span>
      $$<span class="token punctuation">(</span><span class="token function">global_gasprice</span><span class="token punctuation">(</span><span class="token string">"sor.global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span>
      <span class="token punctuation">(</span>gasused <span class="token operator">+</span>
        $$<span class="token punctuation">(</span><span class="token function">local_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"sor.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span>
        failCount <span class="token operator">+</span>
        $$<span class="token punctuation">(</span><span class="token function">local_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"sor.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>penalty <span class="token operator">></span> provision<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      penalty <span class="token operator">=</span> provision<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Here we write to storage the new maker balance. This occurs <em>after</em> possible reentrant calls. How do we know we’re not crediting twice the same amounts? Because the <code>offer</code>’s provision was set to 0 in storage (through <code>dirtyDeleteOffer</code>) before the reentrant calls. In this function, we are working with cached copies of the offer as it was before it was consumed.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>790
791
792
793
794
795
796
797
798
799
800
801</pre></code>
          <pre>    <span class="token function">creditWei</span><span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">offerDetail_maker</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> provision <span class="token operator">-</span> penalty<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> penalty<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">sendPenalty</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>amount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token builtin">bool</span> noRevert<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span>call<span class="token punctuation">{</span>value<span class="token punctuation">:</span> amount<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>noRevert<span class="token punctuation">,</span> <span class="token string">"mgv/sendPenaltyReverted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Post-trade, <code>payTakerMinusFees</code> sends what’s due to the taker and the rest (the fees) to the vault. Routing through the Mangrove like that also deals with blacklisting issues (separates the maker-blacklisted and the taker-blacklisted cases).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>803
804
805</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">payTakerMinusFees</span><span class="token punctuation">(</span>MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span> ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span>
    <span class="token keyword">internal</span>
  <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Should be statically provable that the 2 transfers below cannot return false under well-behaved ERC20s and a non-blacklisted, non-0 target.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>807
808
809
810
811
812
813
814
815
816
817
818
819
820
821
822
823</pre></code>
          <pre>
    <span class="token builtin">uint</span> concreteFee <span class="token operator">=</span> <span class="token punctuation">(</span>mor<span class="token punctuation">.</span>totalGot <span class="token operator">*</span> $$<span class="token punctuation">(</span><span class="token function">local_fee</span><span class="token punctuation">(</span><span class="token string">"sor.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">10</span>_000<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>concreteFee <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mor<span class="token punctuation">.</span>totalGot <span class="token operator">-=</span> concreteFee<span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>
        <span class="token function">transferToken</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span> vault<span class="token punctuation">,</span> concreteFee<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"mgv/feeTransferFail"</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mor<span class="token punctuation">.</span>totalGot <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>
        <span class="token function">transferToken</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>taker<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>totalGot<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"mgv/MgvFailToPayTaker"</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertaking.sol-misc.-functions">Misc. functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Regular solidity reverts prepend the string argument with a <a href="https://docs.soliditylang.org/en/v0.7.6/control-structures.html#revert">function signature</a>. Since we wish to transfer data through a revert, the <code>innerRevert</code> function does a low-level revert with only the required data. <code>innerCode</code> decodes this data.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>827
828
829
830
831
832
833
834
835</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">innerDecode</span><span class="token punctuation">(</span><span class="token builtin">bytes</span> <span class="token keyword">memory</span> data<span class="token punctuation">)</span>
    <span class="token keyword">internal</span>
    <span class="token keyword">pure</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span>
      <span class="token builtin">bytes32</span> mgvData<span class="token punctuation">,</span>
      <span class="token builtin">uint</span> gasused<span class="token punctuation">,</span>
      <span class="token builtin">bytes32</span> makerData
    <span class="token punctuation">)</span>
  <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The <code>data</code> pointer is of the form <code>[mgvData,gasused,makerData]</code> where each array element is contiguous and has size 256 bits.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>837
838
839
840
841
842
843</pre></code>
          <pre>    <span class="token keyword">assembly</span> <span class="token punctuation">{</span>
      mgvData <span class="token operator">:=</span> <span class="token function">mload</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      gasused <span class="token operator">:=</span> <span class="token function">mload</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      makerData <span class="token operator">:=</span> <span class="token function">mload</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="MgvOfferTaking/innerRevert"></a><code>innerRevert</code> reverts a raw triple of values to be interpreted by <code>innerDecode</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>845
846
847
848
849
850</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">innerRevert</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> data<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token punctuation">{</span>
    <span class="token keyword">assembly</span> <span class="token punctuation">{</span>
      <span class="token keyword">revert</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>transferTokenFrom</code> is adapted from <a href="https://soliditydeveloper.com/safe-erc20">existing code</a> and in particular avoids the
“no return value” bug. It never throws and returns true iff the transfer was successful according to <code>tokenAddress</code>.</p>
<p>Note that any spurious exception due to an error in Mangrove code will be falsely blamed on <code>from</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>856
857
858
859
860
861
862
863
864
865
866
867
868
869
870
871
872
873
874
875
876
877
878
879
880
881
882
883
884
885</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">transferTokenFrom</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> tokenAddress<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span>
    <span class="token builtin">address</span> to<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> value
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> cd <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodeWithSelector</span><span class="token punctuation">(</span>
      IERC20<span class="token punctuation">.</span>transferFrom<span class="token punctuation">.</span>selector<span class="token punctuation">,</span>
      <span class="token keyword">from</span><span class="token punctuation">,</span>
      to<span class="token punctuation">,</span>
      value
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token builtin">bool</span> noRevert<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> data<span class="token punctuation">)</span> <span class="token operator">=</span> tokenAddress<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>cd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>noRevert <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> abi<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">transferToken</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> tokenAddress<span class="token punctuation">,</span>
    <span class="token builtin">address</span> to<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> value
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> cd <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodeWithSelector</span><span class="token punctuation">(</span>
      IERC20<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>selector<span class="token punctuation">,</span>
      to<span class="token punctuation">,</span>
      value
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token builtin">bool</span> noRevert<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> data<span class="token punctuation">)</span> <span class="token operator">=</span> tokenAddress<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>cd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>noRevert <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> abi<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mgvoffertakingwithpermit.sol" class="left filebreak">MgvOfferTakingWithPermit.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7
8
9</pre></code>
          <pre>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.7.0</span><span class="token punctuation">;</span>
<span class="token keyword">pragma</span> abicoder v2<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>HasMgvEvents<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvLib.sol"</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvOfferTaking<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvOfferTaking.sol"</span><span class="token punctuation">;</span>

abstract <span class="token keyword">contract</span> <span class="token class-name">MgvOfferTakingWithPermit</span> <span class="token keyword">is</span> MgvOfferTaking <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Takers may provide allowances on specific pairs, so other addresses can execute orders in their name. Allowance may be set using the usual <code>approve</code> function, or through an <a href="https://eips.ethereum.org/EIPS/eip-712">EIP712</a> <code>permit</code>.</p>
<p>The mapping is <code>outbound_tkn =&gt; inbound_tkn =&gt; owner =&gt; spender =&gt; allowance</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>13
14</pre></code>
          <pre>  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> allowances<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Storing nonces avoids replay attacks.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>16</pre></code>
          <pre>  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">public</span> nonces<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Following <a href="https://eips.ethereum.org/EIPS/eip-712">EIP712</a>, structured data signing has <code>keccak256(&quot;Permit(address outbound_tkn,address inbound_tkn,address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)&quot;)</code> in its prefix.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>18
19</pre></code>
          <pre>  <span class="token builtin">bytes32</span> <span class="token keyword">public</span> <span class="token keyword">constant</span> PERMIT_TYPEHASH <span class="token operator">=</span>
    <span class="token number">0xb7bf278e51ab1478b10530c0300f911d9ed3562fc93ab5e6593368fe23c077a2</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Initialized in the constructor, <code>DOMAIN_SEPARATOR</code> avoids cross-application permit reuse.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>21
22
23</pre></code>
          <pre>  <span class="token builtin">bytes32</span> <span class="token keyword">public</span> immutable DOMAIN_SEPARATOR<span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span> contractName<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Initialize <a href="https://eips.ethereum.org/EIPS/eip-712">EIP712</a> <code>DOMAIN_SEPARATOR</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></code>
          <pre>    <span class="token builtin">uint</span> chainId<span class="token punctuation">;</span>
    <span class="token keyword">assembly</span> <span class="token punctuation">{</span>
      chainId <span class="token operator">:=</span> <span class="token function">chainid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    DOMAIN_SEPARATOR <span class="token operator">=</span> <span class="token function">keccak256</span><span class="token punctuation">(</span>
      abi<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>
        <span class="token function">keccak256</span><span class="token punctuation">(</span>
          <span class="token string">"EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">keccak256</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>contractName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">keccak256</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        chainId<span class="token punctuation">,</span>
        <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertakingwithpermit.sol-delegation-public-functions">Delegation public functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Adapted from <a href="https://github.com/Uniswap/uniswap-v2-core/blob/55ae25109b7918565867e5c39f1e84b7edd19b2a/contracts/UniswapV2ERC20.sol#L81">Uniswap v2 contract</a></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">permit</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> owner<span class="token punctuation">,</span>
    <span class="token builtin">address</span> spender<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> value<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> deadline<span class="token punctuation">,</span>
    <span class="token builtin">uint8</span> v<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> r<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> s
  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">{</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>deadline <span class="token operator">>=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span> <span class="token string">"mgv/permit/expired"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">uint</span> nonce <span class="token operator">=</span> nonces<span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token builtin">bytes32</span> digest <span class="token operator">=</span> <span class="token function">keccak256</span><span class="token punctuation">(</span>
      abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
        <span class="token string">"\x19\x01"</span><span class="token punctuation">,</span>
        DOMAIN_SEPARATOR<span class="token punctuation">,</span>
        <span class="token function">keccak256</span><span class="token punctuation">(</span>
          abi<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>
            PERMIT_TYPEHASH<span class="token punctuation">,</span>
            outbound_tkn<span class="token punctuation">,</span>
            inbound_tkn<span class="token punctuation">,</span>
            owner<span class="token punctuation">,</span>
            spender<span class="token punctuation">,</span>
            value<span class="token punctuation">,</span>
            nonce<span class="token punctuation">,</span>
            deadline
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">address</span> recoveredAddress <span class="token operator">=</span> <span class="token function">ecrecover</span><span class="token punctuation">(</span>digest<span class="token punctuation">,</span> v<span class="token punctuation">,</span> r<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>
      recoveredAddress <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> recoveredAddress <span class="token operator">==</span> owner<span class="token punctuation">,</span>
      <span class="token string">"mgv/permit/invalidSignature"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    allowances<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token punctuation">[</span>spender<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">Approval</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">approve</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> spender<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> value
  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    allowances<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">[</span>spender<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">Approval</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The delegate version of <code>marketOrder</code> is <code>marketOrderFor</code>, which takes a <code>taker</code> address as additional argument. Penalties incurred by failed offers will still be sent to <code>msg.sender</code>, but exchanged amounts will be transferred from and to the <code>taker</code>. If the <code>msg.sender</code>’s allowance for the given <code>outbound_tkn</code>,<code>inbound_tkn</code> and <code>taker</code> are strictly less than the total amount eventually spent by <code>taker</code>, the call will fail.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><em>Note:</em> <code>marketOrderFor</code> and <code>snipesFor</code> may emit ERC20 <code>Transfer</code> events of value 0 from <code>taker</code>, but that’s already the case with common ERC20 implementations.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">marketOrderFor</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerGives<span class="token punctuation">,</span>
    <span class="token builtin">bool</span> fillWants<span class="token punctuation">,</span>
    <span class="token builtin">address</span> taker
  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> takerGot<span class="token punctuation">,</span> <span class="token builtin">uint</span> takerGave<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>takerGot<span class="token punctuation">,</span> takerGave<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">generalMarketOrder</span><span class="token punctuation">(</span>
      outbound_tkn<span class="token punctuation">,</span>
      inbound_tkn<span class="token punctuation">,</span>
      takerWants<span class="token punctuation">,</span>
      takerGives<span class="token punctuation">,</span>
      fillWants<span class="token punctuation">,</span>
      taker
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">deductSenderAllowance</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> taker<span class="token punctuation">,</span> takerGave<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The delegate version of <code>snipes</code> is <code>snipesFor</code>, which takes a <code>taker</code> address as additional argument.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">snipesFor</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">calldata</span> targets<span class="token punctuation">,</span>
    <span class="token builtin">bool</span> fillWants<span class="token punctuation">,</span>
    <span class="token builtin">address</span> taker
  <span class="token punctuation">)</span>
    <span class="token keyword">external</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span>
      <span class="token builtin">uint</span> successes<span class="token punctuation">,</span>
      <span class="token builtin">uint</span> takerGot<span class="token punctuation">,</span>
      <span class="token builtin">uint</span> takerGave
    <span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>successes<span class="token punctuation">,</span> takerGot<span class="token punctuation">,</span> takerGave<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">generalSnipes</span><span class="token punctuation">(</span>
      outbound_tkn<span class="token punctuation">,</span>
      inbound_tkn<span class="token punctuation">,</span>
      targets<span class="token punctuation">,</span>
      fillWants<span class="token punctuation">,</span>
      taker
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">deductSenderAllowance</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> taker<span class="token punctuation">,</span> takerGave<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertakingwithpermit.sol-misc.-low-level-functions-0">Misc. low-level functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Used by <code>*For</code> functions, its both checks that <code>msg.sender</code> was allowed to use the taker’s funds, and decreases the former’s allowance.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>148
149
150
151
152
153
154
155
156
157
158</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">deductSenderAllowance</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> owner<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> amount
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint</span> allowed <span class="token operator">=</span> allowances<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>allowed <span class="token operator">>=</span> amount<span class="token punctuation">,</span> <span class="token string">"mgv/lowAllowance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    allowances<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> allowed <span class="token operator">-</span> amount<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mgvgovernable.sol" class="left filebreak">MgvGovernable.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7
8</pre></code>
          <pre>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.7.0</span><span class="token punctuation">;</span>
<span class="token keyword">pragma</span> abicoder v2<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>HasMgvEvents<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvRoot<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvRoot.sol"</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">MgvGovernable</span> <span class="token keyword">is</span> MgvRoot <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The <code>governance</code> address. Governance is the only address that can configure parameters.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>10
11
12
13
14
15
16
17
18</pre></code>
          <pre>  <span class="token builtin">address</span> <span class="token keyword">public</span> governance<span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> _governance<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> _gasprice<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasmax
  <span class="token punctuation">)</span> <span class="token function">MgvRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">emit</span> <span class="token function">NewMgv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Initially, governance is open to anyone.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Initialize vault to governance address, and set initial gasprice and gasmax.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>22
23
24</pre></code>
          <pre>    <span class="token function">setVault</span><span class="token punctuation">(</span>_governance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setGasprice</span><span class="token punctuation">(</span>_gasprice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setGasmax</span><span class="token punctuation">(</span>gasmax<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Initialize governance to <code>_governance</code> after parameter setting.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>26
27
28</pre></code>
          <pre>    <span class="token function">setGovernance</span><span class="token punctuation">(</span>_governance<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvgovernable.sol-authonly-check"><code>authOnly</code> check</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>30
31
32
33
34
35
36
37
38
39</pre></code>
          <pre>
  <span class="token keyword">function</span> <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">view</span> <span class="token punctuation">{</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>
      msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> governance <span class="token operator">||</span>
        msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        governance <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">"mgv/unauthorized"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvgovernable.sol-set-configuration-and-mangrove-state">Set configuration and Mangrove state</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvgovernable.sol-locals">Locals</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>active</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">activate</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> fee<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> density<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> overhead_gasbase<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> offer_gasbase
  <span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    locals<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span>
      <span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"locals[outbound_tkn][inbound_tkn]"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"active"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">SetActive</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setFee</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> fee<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setDensity</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> density<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setGasbase</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> overhead_gasbase<span class="token punctuation">,</span> offer_gasbase<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">deactivate</span><span class="token punctuation">(</span><span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span> <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    locals<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span>
      <span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"locals[outbound_tkn][inbound_tkn]"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"active"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">SetActive</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>fee</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>71
72
73
74
75
76</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setFee</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> fee
  <span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>fee</code> is in basis points, i.e. in percents of a percent.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>78
79
80
81
82
83
84</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>fee <span class="token operator">&lt;=</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"mgv/config/fee/&lt;=500"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// at most 5%</span>
    locals<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span>
      <span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"locals[outbound_tkn][inbound_tkn]"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"fee"</span><span class="token punctuation">,</span> <span class="token string">"fee"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">SetFee</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> fee<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>density</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Useless if <code>global.useOracle != 0</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>87
88
89
90
91
92
93
94</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setDensity</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> density
  <span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">checkDensity</span><span class="token punctuation">(</span>density<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/config/density/32bits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>96
97
98
99
100
101</pre></code>
          <pre>    locals<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span>
      <span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"locals[outbound_tkn][inbound_tkn]"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"density"</span><span class="token punctuation">,</span> <span class="token string">"density"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">SetDensity</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> density<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>gasbase</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>103
104
105
106
107
108
109</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setGasbase</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> overhead_gasbase<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> offer_gasbase
  <span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Checking the size of <code>*_gasbase</code> is necessary to prevent a) data loss when <code>*_gasbase</code> is copied to an <code>OfferDetail</code> struct, and b) overflow when <code>*_gasbase</code> is used in calculations.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>111
112
113
114
115
116
117
118</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>
      <span class="token builtin">uint24</span><span class="token punctuation">(</span>overhead_gasbase<span class="token punctuation">)</span> <span class="token operator">==</span> overhead_gasbase<span class="token punctuation">,</span>
      <span class="token string">"mgv/config/overhead_gasbase/24bits"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>
      <span class="token builtin">uint24</span><span class="token punctuation">(</span>offer_gasbase<span class="token punctuation">)</span> <span class="token operator">==</span> offer_gasbase<span class="token punctuation">,</span>
      <span class="token string">"mgv/config/offer_gasbase/24bits"</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>120
121
122
123
124
125
126
127
128
129
130
131</pre></code>
          <pre>    locals<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span>
      <span class="token function">set_local</span><span class="token punctuation">(</span>
        <span class="token string">"locals[outbound_tkn][inbound_tkn]"</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>
          <span class="token punctuation">[</span><span class="token string">"offer_gasbase"</span><span class="token punctuation">,</span> <span class="token string">"offer_gasbase"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">[</span><span class="token string">"overhead_gasbase"</span><span class="token punctuation">,</span> <span class="token string">"overhead_gasbase"</span><span class="token punctuation">]</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">SetGasbase</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> overhead_gasbase<span class="token punctuation">,</span> offer_gasbase<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvgovernable.sol-globals">Globals</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>kill</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>134
135
136
137
138
139</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    global <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_global</span><span class="token punctuation">(</span><span class="token string">"global"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"dead"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">Kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>gasprice</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Useless if <code>global.useOracle is != 0</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>142
143
144
145</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setGasprice</span><span class="token punctuation">(</span><span class="token builtin">uint</span> gasprice<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">checkGasprice</span><span class="token punctuation">(</span>gasprice<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/config/gasprice/16bits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>147
148
149
150
151</pre></code>
          <pre>
    global <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_global</span><span class="token punctuation">(</span><span class="token string">"global"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"gasprice"</span><span class="token punctuation">,</span> <span class="token string">"gasprice"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">SetGasprice</span><span class="token punctuation">(</span>gasprice<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>gasmax</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>153
154</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setGasmax</span><span class="token punctuation">(</span><span class="token builtin">uint</span> gasmax<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Since any new <code>gasreq</code> is bounded above by <code>config.gasmax</code>, this check implies that all offers’ <code>gasreq</code> is 24 bits wide at most.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>156</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint24</span><span class="token punctuation">(</span>gasmax<span class="token punctuation">)</span> <span class="token operator">==</span> gasmax<span class="token punctuation">,</span> <span class="token string">"mgv/config/gasmax/24bits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>158
159
160
161</pre></code>
          <pre>    global <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_global</span><span class="token punctuation">(</span><span class="token string">"global"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"gasmax"</span><span class="token punctuation">,</span> <span class="token string">"gasmax"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">SetGasmax</span><span class="token punctuation">(</span>gasmax<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>governance</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>163
164
165
166
167
168</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setGovernance</span><span class="token punctuation">(</span><span class="token builtin">address</span> governanceAddress<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    governance <span class="token operator">=</span> governanceAddress<span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">SetGovernance</span><span class="token punctuation">(</span>governanceAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>vault</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>170
171
172
173
174
175</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setVault</span><span class="token punctuation">(</span><span class="token builtin">address</span> vaultAddress<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vault <span class="token operator">=</span> vaultAddress<span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">SetVault</span><span class="token punctuation">(</span>vaultAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>monitor</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>177
178
179
180
181
182</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setMonitor</span><span class="token punctuation">(</span><span class="token builtin">address</span> monitor<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    global <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_global</span><span class="token punctuation">(</span><span class="token string">"global"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"monitor"</span><span class="token punctuation">,</span> <span class="token string">"monitor"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">SetMonitor</span><span class="token punctuation">(</span>monitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>useOracle</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>184
185
186
187
188
189
190</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setUseOracle</span><span class="token punctuation">(</span><span class="token builtin">bool</span> useOracle<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">uint</span> _useOracle <span class="token operator">=</span> useOracle <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    global <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_global</span><span class="token punctuation">(</span><span class="token string">"global"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"useOracle"</span><span class="token punctuation">,</span> <span class="token string">"_useOracle"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">SetUseOracle</span><span class="token punctuation">(</span>useOracle<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>notify</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>192
193
194
195
196
197
198</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setNotify</span><span class="token punctuation">(</span><span class="token builtin">bool</span> notify<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">uint</span> _notify <span class="token operator">=</span> notify <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    global <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_global</span><span class="token punctuation">(</span><span class="token string">"global"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"notify"</span><span class="token punctuation">,</span> <span class="token string">"_notify"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">SetNotify</span><span class="token punctuation">(</span>notify<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="abstractmangrove.sol" class="left filebreak">AbstractMangrove.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7
8
9</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.7.0</span><span class="token punctuation">;</span>
<span class="token keyword">pragma</span> abicoder v2<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvLib <span class="token keyword">as</span> ML<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvLib.sol"</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvOfferMaking<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvOfferMaking.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvOfferTakingWithPermit<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvOfferTakingWithPermit.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvGovernable<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvGovernable.sol"</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>AbstractMangrove</code> inherits the three contracts that implement generic Mangrove functionality (<code>MgvGovernable</code>,<code>MgvOfferTakingWithPermit</code> and <code>MgvOfferMaking</code>) but does not implement the abstract functions.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></code>
          <pre>abstract <span class="token keyword">contract</span> <span class="token class-name">AbstractMangrove</span> <span class="token keyword">is</span>
  MgvGovernable<span class="token punctuation">,</span>
  MgvOfferTakingWithPermit<span class="token punctuation">,</span>
  MgvOfferMaking
<span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> governance<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasmax<span class="token punctuation">,</span>
    <span class="token builtin">string</span> <span class="token keyword">memory</span> contractName
  <span class="token punctuation">)</span>
    <span class="token function">MgvOfferTakingWithPermit</span><span class="token punctuation">(</span>contractName<span class="token punctuation">)</span>
    <span class="token function">MgvGovernable</span><span class="token punctuation">(</span>governance<span class="token punctuation">,</span> gasprice<span class="token punctuation">,</span> gasmax<span class="token punctuation">)</span>
  <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mangrove.sol" class="left filebreak">Mangrove.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.7.0</span><span class="token punctuation">;</span>
<span class="token keyword">pragma</span> abicoder v2<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvLib <span class="token keyword">as</span> ML<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvLib.sol"</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>AbstractMangrove<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./AbstractMangrove.sol"</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="Mangrove"></a> The <code>Mangrove</code> contract implements the “normal” version of Mangrove, where the taker flashloans the desired amount to each maker. Each time, makers are called after the loan. When the order is complete, each maker is called once again (with the orderbook unlocked).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></code>
          <pre><span class="token keyword">contract</span> <span class="token class-name">Mangrove</span> <span class="token keyword">is</span> AbstractMangrove <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> governance<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasmax
  <span class="token punctuation">)</span> <span class="token function">AbstractMangrove</span><span class="token punctuation">(</span>governance<span class="token punctuation">,</span> gasprice<span class="token punctuation">,</span> gasmax<span class="token punctuation">,</span> <span class="token string">"Mangrove"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">executeEnd</span><span class="token punctuation">(</span>MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span> ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span>
    <span class="token keyword">internal</span>
    override
  <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">beforePosthook</span><span class="token punctuation">(</span>ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span> <span class="token keyword">internal</span> override <span class="token punctuation">{</span><span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mangrove.sol-flashloan">Flashloan</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>flashloan</code> is for the ‘normal’ mode of operation. It:</p>
<ol>
<li>Flashloans <code>takerGives</code> <code>inbound_tkn</code> from the taker to the maker and returns false if the loan fails.</li>
<li>Runs <code>offerDetail.maker</code>’s <code>execute</code> function.</li>
<li>Returns the result of the operations, with optional makerData to help the maker debug.</li>
</ol>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>30
31
32
33
34</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">flashloan</span><span class="token punctuation">(</span>ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> sor<span class="token punctuation">,</span> <span class="token builtin">address</span> taker<span class="token punctuation">)</span>
    <span class="token keyword">external</span>
    override
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> gasused<span class="token punctuation">)</span>
  <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>flashloan</code> must be used with a call (hence the <code>external</code> modifier) so its effect can be reverted. But a call from the outside would be fatal.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>36</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/flashloan/protected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The transfer taker -&gt; maker is in 2 steps. First, taker-&gt;mgv. Then
mgv-&gt;maker. With a direct taker-&gt;maker transfer, if one of taker/maker
is blacklisted, we can’t tell which one. We need to know which one:
if we incorrectly blame the taker, a blacklisted maker can block a pair forever; if we incorrectly blame the maker, a blacklisted taker can unfairly make makers fail all the time. Of course we assume the Mangrove is not blacklisted. Also note that this setup doesn’t not work well with tokens that take fees or recompute balances at transfer time.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">transferTokenFrom</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span> taker<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sor<span class="token punctuation">.</span>gives<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token function">transferToken</span><span class="token punctuation">(</span>
          sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span>
          $$<span class="token punctuation">(</span><span class="token function">offerDetail_maker</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          sor<span class="token punctuation">.</span>gives
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        gasused <span class="token operator">=</span> <span class="token function">makerExecute</span><span class="token punctuation">(</span>sor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">innerRevert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token string">"mgv/makerReceiveFail"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">innerRevert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token string">"mgv/takerTransferFail"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="invertedmangrove.sol" class="left filebreak">InvertedMangrove.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.7.0</span><span class="token punctuation">;</span>
<span class="token keyword">pragma</span> abicoder v2<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ITaker<span class="token punctuation">,</span> MgvLib <span class="token keyword">as</span> ML<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvLib.sol"</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>AbstractMangrove<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./AbstractMangrove.sol"</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="InvertedMangrove"></a> The <code>InvertedMangrove</code> contract implements the “inverted” version of Mangrove, where each maker loans money to the taker. The taker is then called, and finally each maker is sent its payment and called again (with the orderbook unlocked).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>9
10
11
12
13
14
15</pre></code>
          <pre><span class="token keyword">contract</span> <span class="token class-name">InvertedMangrove</span> <span class="token keyword">is</span> AbstractMangrove <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> governance<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasmax
  <span class="token punctuation">)</span> <span class="token function">AbstractMangrove</span><span class="token punctuation">(</span>governance<span class="token punctuation">,</span> gasprice<span class="token punctuation">,</span> gasmax<span class="token punctuation">,</span> <span class="token string">"InvertedMangrove"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>execute taker trade</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">executeEnd</span><span class="token punctuation">(</span>MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span> ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span>
    <span class="token keyword">internal</span>
    override
  <span class="token punctuation">{</span>
    <span class="token function">ITaker</span><span class="token punctuation">(</span>mor<span class="token punctuation">.</span>taker<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">takerTrade</span><span class="token punctuation">(</span>
      sor<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span>
      sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span>
      mor<span class="token punctuation">.</span>totalGot<span class="token punctuation">,</span>
      mor<span class="token punctuation">.</span>totalGave
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">bool</span> success <span class="token operator">=</span> <span class="token function">transferTokenFrom</span><span class="token punctuation">(</span>
      sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span>
      mor<span class="token punctuation">.</span>taker<span class="token punctuation">,</span>
      <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      mor<span class="token punctuation">.</span>totalGave
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"mgv/takerFailToPayTotal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We use <code>transferFrom</code> with takers (instead of checking <code>balanceOf</code> before/after the call) for the following reason we want the taker to be awaken after all loans have been made, so either</p>
<ol>
<li>The taker gets a list of all makers and loops through them to pay back, or</li>
<li>we call a new taker method “payback” after returning from each maker call, or</li>
<li>we call transferFrom after returning from each maker call</li>
</ol>
<p>So :</p>
<ol>
<li>Would mean accumulating a list of all makers, which would make the market order code too complex</li>
<li>Is OK, but has an extra CALL cost on top of the token transfer, one for each maker. This is unavoidable anyway when calling makerExecute (since the maker must be able to execute arbitrary code at that moment), but we can skip it here.</li>
<li>Is the cheapest, but it has the drawbacks of <code>transferFrom</code>: money must end up owned by the taker, and taker needs to <code>approve</code> Mangrove</li>
</ol>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>46</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">beforePosthook</span><span class="token punctuation">(</span>ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span> <span class="token keyword">internal</span> override <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>transferToken</code> returns false here, we’re in a special (and bad) situation. The taker is returning part of their total loan to a maker, but the maker can’t receive the tokens. Only case we can see: maker is blacklisted. In that case, we send the tokens to the vault, so things have a chance of getting sorted out later (Mangrove is a token black hole).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>48
49
50
51
52
53
54</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token operator">!</span><span class="token function">transferToken</span><span class="token punctuation">(</span>
        sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span>
        $$<span class="token punctuation">(</span><span class="token function">offerDetail_maker</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        sor<span class="token punctuation">.</span>gives
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If that transfer fails there’s nothing we can do – reverting would punish the taker for the maker’s blacklisting.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>56
57
58
59</pre></code>
          <pre>      <span class="token function">transferToken</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span> vault<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>gives<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="invertedmangrove.sol-flashloans">Flashloans</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="invertedmangrove.sol-inverted-flashloan">Inverted Flashloan</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>invertedFlashloan</code> is for the ‘arbitrage’ mode of operation. It:
0. Calls the maker’s <code>execute</code> function. If successful (tokens have been sent to taker):
2. Runs <code>taker</code>’s <code>execute</code> function.
4. Returns the results ofthe operations, with optional makerData to help the maker debug.</p>
<p>There are two ways to do the flashloan:</p>
<ol>
<li>balanceOf before/after</li>
<li>run transferFrom ourselves.</li>
</ol>
<h3>balanceOf pros:</h3>
<ul>
<li>maker may <code>transferFrom</code> another address they control; saves gas compared to Mangrove’s <code>transferFrom</code></li>
<li>maker does not need to <code>approve</code> Mangrove</li>
</ul>
<h3>balanceOf cons</h3>
<ul>
<li>if the ERC20 transfer method has a callback to receiver, the method does not work (the receiver can set its balance to 0 during the callback)</li>
<li>if the taker is malicious, they can analyze the maker code. If the maker goes on any Mangrove2, they may execute code provided by the taker. This would reduce the taker balance and make the maker fail. So the taker could steal the maker’s balance.</li>
</ul>
<p>We choose <code>transferFrom</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>83
84
85
86
87
88</pre></code>
          <pre>
  <span class="token keyword">function</span> <span class="token function">flashloan</span><span class="token punctuation">(</span>ML<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> sor<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">)</span>
    <span class="token keyword">external</span>
    override
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> gasused<span class="token punctuation">)</span>
  <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>invertedFlashloan</code> must be used with a call (hence the <code>external</code> modifier) so its effect can be reverted. But a call from the outside would be fatal.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>90
91
92
93</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/invertedFlashloan/protected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gasused <span class="token operator">=</span> <span class="token function">makerExecute</span><span class="token punctuation">(</span>sor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  </main>
  </body>
</html>
